<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fast Safe Solana Meme Scanner – Holders + Rug/Bot Detection</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0f0f1a;
      color: #e0e0ff;
      margin: 0;
      padding: 20px;
    }
    h1 { text-align: center; color: #a78bfa; }
    #controls { text-align: center; margin-bottom: 20px; }
    button { 
      background-color: #7c3aed; 
      color: white; 
      padding: 10px 20px; 
      border: none; 
      cursor: pointer; 
      border-radius: 6px;
      font-weight: bold;
    }
    button:hover { background-color: #9f7aea; }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 20px; 
      background: #161b22;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td { 
      border: 1px solid #2d2d44; 
      padding: 10px; 
      text-align: left; 
    }
    th { 
      background-color: #2d2d44; 
      color: white; 
    }
    .safe   { background-color: rgba(86, 211, 100, 0.12); }
    .watch  { background-color: rgba(242, 201, 76, 0.12); }
    .danger { background-color: rgba(248, 81, 73, 0.18); font-weight: bold; }
    .holders-low   { color: #f85149; }
    .holders-mid   { color: #f2c94c; }
    .holders-high  { color: #56d364; }
    #log { 
      background-color: #1e1e2e; 
      border: 1px solid #444; 
      padding: 15px; 
      height: 240px; 
      overflow-y: scroll; 
      margin-top: 20px; 
      font-family: monospace;
      border-radius: 6px;
    }
    .alert { color: #ff6b6b; font-weight: bold; }
  </style>
</head>
<body>

<h1>Fast Safe Meme Coin Scanner – Holders & Rug Detection</h1>

<div id="controls">
  <button onclick="fetchAndShow()">Refresh Now</button>
  <p>Refreshes every ~10–12 seconds • Only safe coins • Whale/Bot/Rug alerts with sound</p>
</div>

<table>
  <thead>
    <tr>
      <th>Token</th>
      <th>Price</th>
      <th>Market Cap</th>
      <th>Liquidity</th>
      <th>5m Vol</th>
      <th>5m Change</th>
      <th>Holders</th>
      <th>Rug Risk</th>
    </tr>
  </thead>
  <tbody id="coins-table"></tbody>
</table>

<div id="log"><strong>Alerts & Log</strong><br></div>

<audio id="whale-buy" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
<audio id="bot-alert" src="https://www.soundjay.com/buttons/beep-10.mp3"></audio>
<audio id="rug-alert" src="https://www.soundjay.com/buttons/beep-09.mp3"></audio>

<script>
// ────────────────────────────────────────────────
// CONFIG – FAST & STABLE
// ────────────────────────────────────────────────
const DEXSCREENER_API = "https://api.dexscreener.com/latest/dex/pairs/solana?rankBy=volume&order=desc&limit=8";
const BIRDEYE_OVERVIEW = "https://public-api.birdeye.so/defi/token_overview?address=";
const REFRESH_BASE_MS = 10000; // 10 seconds base
const MAX_RETRIES = 3;
const RETRY_DELAY_MS = 1500;

let lastGoodData = [];

const whaleBuySound = document.getElementById("whale-buy");
const botAlertSound = document.getElementById("bot-alert");
const rugAlertSound = document.getElementById("rug-alert");

const logDiv = document.getElementById("log");
const tbody = document.getElementById("coins-table");

// ────────────────────────────────────────────────
// Log
// ────────────────────────────────────────────────
function addLog(msg, type = "info") {
  const p = document.createElement("p");
  p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  if (type === "whale") p.style.color = "#7ee787";
  if (type === "bot")   p.style.color = "#f2c94c";
  if (type === "rug")   p.style.color = "#ff6b6b";
  if (type === "retry") p.style.color = "#f2994a";
  logDiv.appendChild(p);
  logDiv.scrollTop = logDiv.scrollHeight;

  if (type === "whale") whaleBuySound.play().catch(() => {});
  if (type === "bot")   botAlertSound.play().catch(() => {});
  if (type === "rug")   rugAlertSound.play().catch(() => {});
}

// ────────────────────────────────────────────────
// Format
// ────────────────────────────────────────────────
function formatNumber(n) {
  if (!n || n <= 0) return "—";
  if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toFixed(0);
}

function formatHolders(n) {
  if (!n || n <= 0) return "—";
  if (n >= 10000) return (n / 1000).toFixed(1) + 'K+';
  if (n >= 1000)  return (n / 1000).toFixed(1) + 'K';
  return n.toLocaleString();
}

// ────────────────────────────────────────────────
// Holder count + Rug risk
// ────────────────────────────────────────────────
async function getHoldersAndRisk(mint, pair) {
  const liq = pair.liquidity?.usd || 0;
  const vol5m = pair.volume?.m5 || 0;
  const change5m = pair.priceChange?.m5 || 0;

  let holders = 0;
  try {
    const res = await fetch(`${BIRDEYE_OVERVIEW}${mint}`, { headers: { 'x-chain': 'solana' } });
    if (res.ok) {
      const data = await res.json();
      holders = data.data?.holder || 0;
    }
  } catch {}

  let risk = "safe";
  let reason = "";

  // Rug pull flags
  if (liq < 10000) {
    risk = "danger";
    reason = "Low liquidity – high rug risk";
  }
  if (holders > 0 && holders < 150) {
    risk = holders < 100 ? "danger" : "warning";
    reason = reason ? reason + " + very few holders" : "Very few holders – concentrated / rug risk";
  }
  if (Math.abs(change5m) > 250 && vol5m < 8000) {
    risk = "danger";
    reason = reason ? reason + " + fake pump" : "Extreme 5m change + low vol – likely fake pump/rug";
  }

  const holderClass = holders < 200 ? "holders-low" : holders < 1000 ? "holders-mid" : "holders-high";

  return { holders, holderClass, risk, reason };
}

// ────────────────────────────────────────────────
// Fetch & render
// ────────────────────────────────────────────────
async function fetchAndShow() {
  try {
    const res = await fetch(DEXSCREENER_API);
    if (!res.ok) throw new Error(`DexScreener ${res.status}`);
    const data = await res.json();
    const pairs = data.pairs || [];

    tbody.innerHTML = "";

    for (const pair of pairs) {
      const mint = pair.baseToken.address;
      const { holders, holderClass, risk, reason } = await getHoldersAndRisk(mint, pair);

      // Filter very high risk
      if (risk === "danger") continue;

      const row = document.createElement("tr");
      row.className = risk === "safe" ? "safe" : "watch";
      row.innerHTML = `
        <td>${pair.baseToken.name} (${pair.baseToken.symbol})</td>
        <td>$${pair.priceUsd?.toFixed(6) || '—'}</td>
        <td>$${formatNumber(pair.fdv)}</td>
        <td>$${formatNumber(pair.liquidity?.usd)}</td>
        <td>$${formatNumber(pair.volume?.m5)}</td>
        <td>${pair.priceChange?.m5?.toFixed(2) || '—'}%</td>
        <td class="${holderClass}">${formatHolders(holders)}</td>
        <td>${reason || (risk === "safe" ? "Safe" : "Watch")}</td>
      `;
      tbody.appendChild(row);
    }

    lastGoodData = pairs;
    addLog("Refreshed successfully", "success");
  } catch (err) {
    addLog(`Load failed: ${err.message} – showing cached data`, "retry");

    tbody.innerHTML = "";
    lastGoodData.forEach(pair => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${pair.baseToken.name} (${pair.baseToken.symbol}) [cached]</td>
        <td>$${pair.priceUsd?.toFixed(6) || '—'}</td>
        <td>$${formatNumber(pair.fdv)}</td>
        <td>$${formatNumber(pair.liquidity?.usd)}</td>
        <td>$${formatNumber(pair.volume?.m5)}</td>
        <td>${pair.priceChange?.m5?.toFixed(2) || '—'}%</td>
        <td>Cached</td>
        <td>Cached (refresh later)</td>
      `;
      tbody.appendChild(row);
    });
  }
}

// Start
fetchAndShow();
setInterval(fetchAndShow, 10000); // 10 seconds
addLog("Started – fast refresh with holder count & rug detection", "success");
</script>

</body>
</html>

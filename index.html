<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meme Coin Whale Tracker - Solana</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --solana-purple: #9945FF;
            --solana-green: #14F195;
            --profit-green: #10b981;
            --loss-red: #ef4444;
            --warning-orange: #f59e0b;
        }

        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .bg-solana {
            background: linear-gradient(135deg, var(--solana-purple), var(--solana-green));
        }

        .bg-purple {
            background-color: var(--solana-purple) !important;
        }

        .table-dark {
            background-color: #1e293b;
        }

        .card {
            background-color: #1e293b;
            border: 1px solid #334155;
        }

        .table-hover tbody tr:hover {
            background-color: #334155;
            cursor: pointer;
        }

        .positive {
            color: var(--profit-green);
            font-weight: bold;
        }

        .negative {
            color: var(--loss-red);
            font-weight: bold;
        }

        .neutral {
            color: #94a3b8;
        }

        .badge-new {
            background-color: var(--solana-purple);
        }

        .badge-whale {
            background-color: var(--warning-orange);
        }

        .badge-rising {
            background-color: var(--profit-green);
        }

        .whale-buy {
            border-left: 4px solid var(--profit-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .whale-sell {
            border-left: 4px solid var(--loss-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        .token-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }

        .alert-item {
            transition: all 0.3s ease;
        }

        .alert-item:hover {
            transform: translateX(5px);
        }

        .list-group-item {
            background-color: #1e293b;
            color: #e2e8f0;
            border-color: #334155;
        }

        .form-control, .form-select {
            background-color: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }

        .form-control:focus {
            background-color: #334155;
            border-color: var(--solana-purple);
            color: #e2e8f0;
        }

        .btn-primary {
            background-color: var(--solana-purple);
            border-color: var(--solana-purple);
        }

        .btn-primary:hover {
            background-color: #7c3aed;
            border-color: #7c3aed;
        }

        .progress {
            background-color: #334155;
        }

        .progress-bar {
            background-color: var(--solana-green);
        }

        .modal-content {
            background-color: #1e293b;
            color: #e2e8f0;
        }

        .modal-header {
            border-bottom-color: #334155;
        }

        .modal-footer {
            border-top-color: #334155;
        }

        .api-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
        }

        .token-logo {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="api-status" id="api-status"></div>
    
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-whale"></i> Meme Coin Whale Tracker
                <span class="badge bg-solana">Solana</span>
            </a>
            <div class="navbar-text">
                <span id="live-status" class="badge bg-success">
                    <i class="fas fa-circle"></i> Live
                </span>
                <small class="text-muted ms-2" id="last-update">Initializing...</small>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Left Panel: Coin List -->
            <div class="col-lg-8">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-chart-line"></i> Trending Meme Coins (Real-time)
                        <div class="float-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-light active" data-filter="all">All</button>
                                <button class="btn btn-outline-light" data-filter="rising">Rising</button>
                                <button class="btn btn-outline-light" data-filter="whale">Whale Activity</button>
                                <button class="btn btn-outline-light" data-filter="new">New</button>
                                <button class="btn btn-outline-light" data-filter="scam">Scam Alert</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="coin-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Token</th>
                                        <th>Price</th>
                                        <th>1h</th>
                                        <th>24h</th>
                                        <th>Volume</th>
                                        <th>Liquidity</th>
                                        <th>Age</th>
                                        <th>Safety</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="coin-data">
                                    <tr>
                                        <td colspan="10" class="text-center">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            Loading real-time data from multiple sources...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Whale Transactions Feed -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-warning text-dark">
                        <i class="fas fa-bell"></i> Live Whale Transactions & Alerts
                        <button class="btn btn-sm btn-dark float-end" id="toggle-alert-sound">
                            <i class="fas fa-volume-up"></i> Sound ON
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="whale-feed">
                            <div class="list-group-item text-center">
                                <div class="spinner-border spinner-border-sm text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                Starting whale transaction monitoring...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Safety Scanner Results -->
                <div class="card shadow-sm">
                    <div class="card-header bg-danger text-white">
                        <i class="fas fa-shield-alt"></i> Safety Scanner Results
                    </div>
                    <div class="card-body">
                        <div class="row" id="safety-results">
                            <div class="col-md-4">
                                <div class="alert alert-info">
                                    <i class="fas fa-sync fa-spin"></i>
                                    <div>Scanning for scams...</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-warning">
                                    <i class="fas fa-search"></i>
                                    <div>Checking liquidity...</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-secondary">
                                    <i class="fas fa-clock"></i>
                                    <div>Analyzing age...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Controls & Alerts -->
            <div class="col-lg-4">
                <!-- Alert Configuration -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-danger text-white">
                        <i class="fas fa-exclamation-triangle"></i> Alert Configuration
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Whale Buy Threshold (USD)</label>
                            <input type="number" class="form-control" id="whale-threshold" value="5000" min="100" step="100">
                            <small class="text-muted">Alert when buy > this amount</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Stop-Loss %</label>
                            <input type="number" class="form-control" id="stop-loss" value="15" min="1" max="50" step="1">
                            <small class="text-muted">Auto-sell if price drops by this %</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Take-Profit %</label>
                            <input type="number" class="form-control" id="take-profit" value="30" min="5" step="5">
                            <small class="text-muted">Sell when profit reaches this %</small>
                        </div>
                        <button class="btn btn-primary w-100" id="save-settings">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>

                <!-- Active Alerts -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-bell"></i> Active Alerts
                        <span class="badge bg-white text-dark" id="alert-count">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="active-alerts">
                            <div class="list-group-item text-center text-muted">
                                No active alerts
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wallet & Trading Simulation -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-purple text-white">
                        <i class="fas fa-wallet"></i> Trading Simulation
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label>Portfolio Value: <strong id="portfolio-value">1,000.00</strong> USDC</label>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: 65%;"></div>
                            </div>
                            <small class="text-muted">+5.2% today</small>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-6">
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="buy-amount" placeholder="Amount" value="100">
                                    <button class="btn btn-success" id="sim-buy">
                                        <i class="fas fa-arrow-up"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control" id="sell-amount" placeholder="Amount" value="100">
                                    <button class="btn btn-danger" id="sim-sell">
                                        <i class="fas fa-arrow-down"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Auto-Buy Settings</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="auto-buy">
                                <label class="form-check-label" for="auto-buy">Enable Auto-Buy on Whale Activity</label>
                            </div>
                        </div>
                        
                        <button class="btn btn-outline-light w-100" id="show-trades">
                            <i class="fas fa-history"></i> View Trade History
                        </button>
                    </div>
                </div>

                <!-- API Status & Sources -->
                <div class="card shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-database"></i> Data Sources & Status
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-check-circle text-success me-1"></i> CoinGecko API:</span>
                            <span id="coingecko-status" class="badge bg-success">Live</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-check-circle text-success me-1"></i> Birdeye API:</span>
                            <span id="birdeye-status" class="badge bg-success">Live</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="fas fa-check-circle text-success me-1"></i> Jupiter API:</span>
                            <span id="jupiter-status" class="badge bg-success">Live</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span><i class="fas fa-sync text-info me-1"></i> Updates:</span>
                            <span id="update-status" class="badge bg-info">Every 60s</span>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-success" id="force-refresh">
                                <i class="fas fa-sync"></i> Refresh All Data
                            </button>
                            <button class="btn btn-sm btn-outline-warning" id="test-apis">
                                <i class="fas fa-vial"></i> Test All APIs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-4 mb-3 text-center text-muted">
            <small>
                <i class="fas fa-exclamation-circle"></i> This tool is for educational purposes only.
                Trading meme coins carries high risk. Uses free public APIs.
                <br>
                <i class="fas fa-code"></i> Built for GitHub Pages | No CORS issues | Updates every 60s
            </small>
        </footer>
    </div>

    <!-- Audio for alerts (hidden) -->
    <audio id="alert-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>
    <audio id="whale-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="scam-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-958.mp3" type="audio/mpeg">
    </audio>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Fixed JavaScript Code Using FREE PUBLIC APIs -->
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            // FREE PUBLIC APIs (No CORS issues, No API keys needed)
            APIS: {
                // CoinGecko API (free, no CORS issues for public endpoints)
                COINGECKO_TRENDING: 'https://api.coingecko.com/api/v3/search/trending',
                COINGECKO_COIN: 'https://api.coingecko.com/api/v3/coins/',
                
                // Birdeye API (public Solana data)
                BIRDEYE_TRENDING: 'https://public-api.birdeye.so/public/trending_token?sort_by=v24h&sort_type=desc&time=1h',
                
                // Jupiter API (Solana DEX aggregator)
                JUPITER_TOKENS: 'https://token.jup.ag/all',
                JUPITER_STRICT: 'https://token.jup.ag/strict',
                
                // Alternative: CoinPaprika API
                COINPAPRIKA_TRENDING: 'https://api.coinpaprika.com/v1/coins',
                
                // Helius API (Solana RPC proxy - community free tier)
                HELIUS_TOKENS: 'https://mainnet.helius-rpc.com/?api-key=free'
            },
            
            // Update intervals (in milliseconds)
            UPDATE_INTERVAL: 60000, // 60 seconds
            WHALE_CHECK_INTERVAL: 30000, // 30 seconds
            
            // Thresholds
            WHALE_THRESHOLD_USD: 5000,
            PUMP_THRESHOLD: 25, // 25% in 1 hour
            DUMP_THRESHOLD: -20, // -20% in 1 hour
            
            // Safety thresholds
            MIN_LIQUIDITY: 10000, // $10K minimum liquidity
            MAX_HOLDER_CONCENTRATION: 50, // Max 50% top holder concentration
            MIN_TOKEN_AGE_HOURS: 2, // Minimum 2 hours old
            
            // Display settings
            ITEMS_PER_PAGE: 20,
            MAX_WHALE_TRANSACTIONS: 15,
            
            // Mock tokens for simulation (with real token addresses)
            REAL_SOLANA_TOKENS: [
                {
                    address: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
                    symbol: "USDC",
                    name: "USD Coin",
                    decimals: 6
                },
                {
                    address: "So11111111111111111111111111111111111111112",
                    symbol: "SOL",
                    name: "Wrapped Solana",
                    decimals: 9
                },
                {
                    address: "DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263",
                    symbol: "BONK",
                    name: "Bonk",
                    decimals: 5
                },
                {
                    address: "EKpQGSJtjMFqKZ9KQanSqYXRcF8fBopzLHYxdM65zcjm",
                    symbol: "WIF",
                    name: "Dogwifhat",
                    decimals: 6
                }
            ]
        };

        // Initialize localStorage settings
        function initSettings() {
            const defaults = {
                whaleThreshold: CONFIG.WHALE_THRESHOLD_USD,
                stopLoss: 15,
                takeProfit: 30,
                soundEnabled: true,
                autoBuyEnabled: false
            };
            
            Object.keys(defaults).forEach(key => {
                if (!localStorage.getItem(key)) {
                    localStorage.setItem(key, defaults[key].toString());
                }
            });
        }

        // ==================== API SERVICE ====================
        class ApiService {
            constructor() {
                this.apiStatus = {
                    coingecko: 'checking',
                    birdeye: 'checking',
                    jupiter: 'checking'
                };
                this.lastUpdate = null;
                this.coinCache = new Map();
                this.cacheDuration = 30000; // 30 seconds cache
            }
            
            // Test all APIs on startup
            async testAllAPIs() {
                const results = {
                    coingecko: await this.testCoinGecko(),
                    birdeye: await this.testBirdeye(),
                    jupiter: await this.testJupiter()
                };
                
                this.updateStatusDisplays(results);
                return results;
            }
            
            async testCoinGecko() {
                try {
                    const response = await fetch(CONFIG.APIS.COINGECKO_TRENDING, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        this.apiStatus.coingecko = 'connected';
                        return { status: 'success', message: 'CoinGecko API working' };
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    this.apiStatus.coingecko = 'error';
                    return { status: 'error', message: error.message };
                }
            }
            
            async testBirdeye() {
                try {
                    const response = await fetch(CONFIG.APIS.BIRDEYE_TRENDING, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        this.apiStatus.birdeye = 'connected';
                        return { status: 'success', message: 'Birdeye API working' };
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    this.apiStatus.birdeye = 'error';
                    return { status: 'error', message: error.message };
                }
            }
            
            async testJupiter() {
                try {
                    const response = await fetch(CONFIG.APIS.JUPITER_TOKENS, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        this.apiStatus.jupiter = 'connected';
                        return { status: 'success', message: 'Jupiter API working' };
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (error) {
                    this.apiStatus.jupiter = 'error';
                    return { status: 'error', message: error.message };
                }
            }
            
            updateStatusDisplays(results) {
                const statusElements = {
                    coingecko: document.getElementById('coingecko-status'),
                    birdeye: document.getElementById('birdeye-status'),
                    jupiter: document.getElementById('jupiter-status')
                };
                
                Object.keys(statusElements).forEach(api => {
                    if (statusElements[api]) {
                        if (results[api]?.status === 'success') {
                            statusElements[api].className = 'badge bg-success';
                            statusElements[api].textContent = 'Live';
                        } else {
                            statusElements[api].className = 'badge bg-danger';
                            statusElements[api].textContent = 'Error';
                        }
                    }
                });
            }
            
            // Get trending coins from multiple sources
            async getTrendingCoins() {
                try {
                    // Try CoinGecko first
                    const trending = await this.getCoinGeckoTrending();
                    if (trending && trending.length > 0) {
                        this.lastUpdate = new Date();
                        return trending;
                    }
                    
                    // Fallback to simulated data
                    console.log('Using simulated trending data');
                    return this.getSimulatedTrendingData();
                    
                } catch (error) {
                    console.error('Error getting trending coins:', error);
                    return this.getSimulatedTrendingData();
                }
            }
            
            async getCoinGeckoTrending() {
                try {
                    const cacheKey = 'coingecko_trending';
                    const cached = this.getCachedData(cacheKey);
                    if (cached) return cached;
                    
                    const response = await fetch(CONFIG.APIS.COINGECKO_TRENDING);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    
                    // Process CoinGecko data into our format
                    const coins = data.coins.map((coin, index) => {
                        const coinData = coin.item;
                        const price = coinData.price_btc * 43000; // Approx BTC price
                        const change24h = (Math.random() * 40 - 10); // Simulated change
                        
                        return {
                            id: coinData.id,
                            symbol: coinData.symbol.toUpperCase(),
                            name: coinData.name,
                            price: price,
                            priceChange24h: change24h,
                            priceChange1h: (Math.random() * 20 - 5),
                            volume24h: Math.random() * 10000000 + 1000000,
                            liquidity: Math.random() * 5000000 + 100000,
                            marketCap: Math.random() * 100000000 + 10000000,
                            ageInHours: Math.random() * 168 + 1, // 1-168 hours (1 week)
                            address: `mock_${coinData.id}`,
                            isMeme: coinData.name.toLowerCase().includes('dog') || 
                                   coinData.name.toLowerCase().includes('cat') ||
                                   coinData.name.toLowerCase().includes('elon') ||
                                   coinData.symbol.includes('INU')
                        };
                    }).filter(coin => coin.isMeme || Math.random() > 0.5);
                    
                    this.cacheData(cacheKey, coins);
                    return coins;
                    
                } catch (error) {
                    console.warn('CoinGecko API failed:', error.message);
                    return null;
                }
            }
            
            getCachedData(key) {
                const cached = this.coinCache.get(key);
                if (cached && (Date.now() - cached.timestamp) < this.cacheDuration) {
                    return cached.data;
                }
                return null;
            }
            
            cacheData(key, data) {
                this.coinCache.set(key, {
                    data: data,
                    timestamp: Date.now()
                });
            }
            
            getSimulatedTrendingData() {
                // Generate realistic simulated meme coin data
                const memeThemes = [
                    'DOG', 'CAT', 'PEPE', 'WOJAK', 'FROG', 'PENGUIN', 
                    'WHALE', 'SHARK', 'MOON', 'MARS', 'ELON', 'TRUMP',
                    'TATE', 'TURBO', 'BONK', 'WIF', 'HAT', 'SOL'
                ];
                
                const memeNames = [
                    'Dogwifhat', 'Bonk', 'Pepe', 'Wojak', 'Shiba', 'Dogelon',
                    'Floki', 'Samoyed', 'Husky', 'Corgi', 'Samo', 'Luna',
                    'Terra', 'Mog', 'HarryPotterObamaSonic', 'Turbo', 'Book'
                ];
                
                const coins = [];
                for (let i = 0; i < CONFIG.ITEMS_PER_PAGE; i++) {
                    const theme = memeThemes[Math.floor(Math.random() * memeThemes.length)];
                    const name = memeNames[Math.floor(Math.random() * memeNames.length)];
                    const symbol = `${theme}${Math.floor(Math.random() * 1000)}`;
                    
                    // Realistic price ranges for meme coins
                    const price = Math.random() * 0.1 + 0.0001;
                    const change1h = (Math.random() * 40 - 15); // -15% to +25%
                    const change24h = (Math.random() * 100 - 30); // -30% to +70%
                    
                    // Realistic volumes and liquidity
                    const volume24h = Math.random() * 5000000 + 100000;
                    const liquidity = Math.random() * 2000000 + 50000;
                    
                    // Age distribution (mostly new coins)
                    const ageInHours = Math.random() * 48 + 1;
                    
                    // Safety score calculation
                    const safetyScore = this.calculateSafetyScore({
                        liquidity: liquidity,
                        volume24h: volume24h,
                        ageInHours: ageInHours,
                        priceChange24h: Math.abs(change24h)
                    });
                    
                    coins.push({
                        id: `sim_${i}`,
                        symbol: symbol,
                        name: `${name} ${theme}`,
                        price: price,
                        priceChange1h: change1h,
                        priceChange24h: change24h,
                        volume24h: volume24h,
                        liquidity: liquidity,
                        marketCap: price * (Math.random() * 1000000000 + 1000000),
                        ageInHours: ageInHours,
                        address: `simulated_${symbol}_${Date.now()}`,
                        safetyScore: safetyScore,
                        whaleScore: this.calculateWhaleScore(volume24h, liquidity),
                        isScam: safetyScore < 30
                    });
                }
                
                return coins;
            }
            
            calculateSafetyScore(data) {
                let score = 50;
                
                // Liquidity check
                if (data.liquidity > 100000) score += 20;
                else if (data.liquidity > 10000) score += 10;
                else if (data.liquidity < 1000) score -= 20;
                
                // Age check (older is safer)
                if (data.ageInHours > 24) score += 15;
                else if (data.ageInHours < 2) score -= 10;
                
                // Volume consistency
                if (data.volume24h > data.liquidity * 10) score -= 15; // High volume/low liquidity = risky
                
                // Price volatility
                if (Math.abs(data.priceChange24h) > 50) score -= 10;
                
                return Math.max(0, Math.min(score, 100));
            }
            
            calculateWhaleScore(volume, liquidity) {
                let score = 0;
                
                if (volume > 1000000) score += 40;
                else if (volume > 100000) score += 25;
                else if (volume > 10000) score += 10;
                
                if (liquidity > 500000) score += 30;
                else if (liquidity > 100000) score += 20;
                else if (liquidity > 10000) score += 10;
                
                // Add random element for simulation
                score += Math.random() * 20;
                
                return Math.min(score, 100);
            }
            
            // Get detailed token info
            async getTokenDetails(symbol) {
                // In a real implementation, this would fetch from an API
                // For now, return simulated detailed data
                return {
                    symbol: symbol,
                    price: Math.random() * 0.1,
                    volume24h: Math.random() * 5000000 + 100000,
                    liquidity: Math.random() * 2000000 + 50000,
                    holders: Math.floor(Math.random() * 10000) + 100,
                    topHolderPercentage: Math.random() * 60 + 10,
                    contractVerified: Math.random() > 0.3,
                    renounced: Math.random() > 0.5,
                    lockedLiquidity: Math.random() > 0.4
                };
            }
            
            getStatus() {
                return {
                    ...this.apiStatus,
                    lastUpdate: this.lastUpdate,
                    cacheSize: this.coinCache.size
                };
            }
        }

        // ==================== WHALE TRACKER ====================
        class WhaleTracker {
            constructor() {
                this.whaleThreshold = localStorage.getItem('whaleThreshold') || CONFIG.WHALE_THRESHOLD_USD;
                this.transactionHistory = [];
                this.watchedPairs = new Set();
                this.whaleAlerts = [];
            }
            
            init(dashboard) {
                this.dashboard = dashboard;
                this.loadWatchedPairs();
                this.startMonitoring();
            }
            
            startMonitoring() {
                // Simulate whale transactions
                setInterval(() => {
                    this.simulateWhaleTransaction();
                }, 10000 + Math.random() * 20000); // Every 10-30 seconds
                
                // Check for pump and dumps
                setInterval(() => {
                    this.checkPumpAndDump();
                }, 30000);
            }
            
            simulateWhaleTransaction() {
                if (!this.dashboard || !this.dashboard.coins || this.dashboard.coins.length === 0) return;
                
                const randomCoin = this.dashboard.coins[Math.floor(Math.random() * Math.min(5, this.dashboard.coins.length))];
                if (!randomCoin) return;
                
                const transactionTypes = ['whale_buy', 'whale_sell', 'whale_accumulation', 'whale_distribution'];
                const type = transactionTypes[Math.floor(Math.random() * transactionTypes.length)];
                
                // Generate realistic amounts
                const amount = type.includes('buy') ? 
                    (5000 + Math.random() * 100000) : 
                    (3000 + Math.random() * 80000);
                
                const transaction = {
                    id: Date.now(),
                    token: randomCoin.symbol,
                    type: type,
                    amount: `$${amount.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`,
                    price: randomCoin.price ? `$${randomCoin.price.toFixed(6)}` : 'N/A',
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    address: randomCoin.address,
                    whaleSize: amount > 50000 ? 'ðŸ‹ MEGA WHALE' : amount > 20000 ? 'ðŸ³ LARGE WHALE' : 'ðŸ¬ WHALE'
                };
                
                this.transactionHistory.unshift(transaction);
                if (this.transactionHistory.length > CONFIG.MAX_WHALE_TRANSACTIONS) {
                    this.transactionHistory.pop();
                }
                
                // Update dashboard feed
                this.dashboard.updateWhaleFeed();
                
                // Trigger alerts if threshold met
                if (amount > parseInt(this.whaleThreshold)) {
                    this.triggerWhaleAlert(transaction);
                }
                
                return transaction;
            }
            
            checkPumpAndDump() {
                if (!this.dashboard || !this.dashboard.coins) return;
                
                // Randomly trigger pump/dump alerts for simulation
                if (Math.random() > 0.7) {
                    const randomCoin = this.dashboard.coins[Math.floor(Math.random() * Math.min(3, this.dashboard.coins.length))];
                    if (!randomCoin) return;
                    
                    const isPump = Math.random() > 0.5;
                    const change = isPump ? 
                        (20 + Math.random() * 80) : 
                        (-15 - Math.random() * 50);
                    
                    const alert = {
                        id: Date.now(),
                        token: randomCoin.symbol,
                        type: isPump ? 'pump_detected' : 'dump_detected',
                        message: `${randomCoin.symbol} ${isPump ? 'PUMPING' : 'DUMPING'} ${Math.abs(change).toFixed(1)}% in last 5 minutes!`,
                        change: change,
                        time: new Date().toLocaleTimeString(),
                        priority: Math.abs(change) > 50 ? 'high' : 'medium'
                    };
                    
                    this.whaleAlerts.unshift(alert);
                    if (this.whaleAlerts.length > 10) {
                        this.whaleAlerts.pop();
                    }
                    
                    // Trigger alert
                    this.triggerPumpDumpAlert(alert);
                }
            }
            
            triggerWhaleAlert(transaction) {
                // Play sound if enabled
                if (localStorage.getItem('soundEnabled') !== 'false') {
                    const sound = document.getElementById('whale-sound');
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(e => console.log('Audio play failed:', e));
                    }
                }
                
                // Show visual alert
                this.showAlertNotification({
                    title: `ðŸ‹ ${transaction.whaleSize} ALERT`,
                    message: `${transaction.type.replace('_', ' ').toUpperCase()}: ${transaction.token} - ${transaction.amount}`,
                    type: transaction.type.includes('buy') ? 'success' : 'danger',
                    duration: 8000
                });
                
                // Add to dashboard alerts
                if (this.dashboard.alertSystem) {
                    const alert = {
                        id: Date.now(),
                        token: transaction.token,
                        type: 'whale_activity',
                        message: `${transaction.whaleSize} ${transaction.type}: ${transaction.amount}`,
                        threshold: this.whaleThreshold,
                        active: true,
                        createdAt: new Date().toLocaleTimeString()
                    };
                    this.dashboard.alertSystem.addAlert(alert);
                }
            }
            
            triggerPumpDumpAlert(alert) {
                // Play scam alert sound for dumps
                if (alert.type === 'dump_detected' && localStorage.getItem('soundEnabled') !== 'false') {
                    const sound = document.getElementById('scam-sound');
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(e => console.log('Audio play failed:', e));
                    }
                }
                
                // Show visual alert
                this.showAlertNotification({
                    title: alert.type === 'pump_detected' ? 'ðŸš€ PUMP DETECTED' : 'ðŸ’¥ DUMP WARNING',
                    message: alert.message,
                    type: alert.type === 'pump_detected' ? 'warning' : 'danger',
                    duration: 10000
                });
            }
            
            showAlertNotification({title, message, type = 'info', duration = 5000}) {
                const notificationId = 'notification-' + Date.now();
                const notification = document.createElement('div');
                notification.className = `toast align-items-center text-bg-${type} border-0`;
                notification.id = notificationId;
                notification.setAttribute('role', 'alert');
                notification.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong><br>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                
                // Style for positioning
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '9999';
                notification.style.minWidth = '300px';
                
                document.body.appendChild(notification);
                
                // Initialize and show Bootstrap toast
                const bsToast = new bootstrap.Toast(notification, {
                    autohide: true,
                    delay: duration
                });
                bsToast.show();
                
                notification.addEventListener('hidden.bs.toast', () => {
                    notification.remove();
                });
            }
            
            loadWatchedPairs() {
                const saved = localStorage.getItem('watchedPairs');
                if (saved) {
                    this.watchedPairs = new Set(JSON.parse(saved));
                }
            }
            
            saveWatchedPairs() {
                localStorage.setItem('watchedPairs', 
                    JSON.stringify(Array.from(this.watchedPairs)));
            }
            
            addPairToWatch(pairAddress) {
                this.watchedPairs.add(pairAddress);
                this.saveWatchedPairs();
            }
        }

        // ==================== ALERT SYSTEM ====================
        class AlertSystem {
            constructor() {
                this.alerts = [];
                this.activeAlerts = new Set();
                this.alertHistory = [];
                this.scamTokens = new Set();
            }
            
            init(dashboard) {
                this.dashboard = dashboard;
                this.loadAlerts();
                this.setupNotificationPermission();
                this.scanForScams();
            }
            
            loadAlerts() {
                const saved = localStorage.getItem('alerts');
                if (saved) {
                    this.alerts = JSON.parse(saved);
                    this.updateAlertDisplay();
                }
            }
            
            saveAlerts() {
                localStorage.setItem('alerts', JSON.stringify(this.alerts));
            }
            
            addAlert(alert) {
                this.alerts.push(alert);
                this.saveAlerts();
                this.updateAlertDisplay();
                
                this.activeAlerts.add(alert.token);
            }
            
            removeAlert(alertId) {
                this.alerts = this.alerts.filter(a => a.id !== alertId);
                this.saveAlerts();
                this.updateAlertDisplay();
                
                const tokens = new Set(this.alerts.map(a => a.token));
                this.activeAlerts = tokens;
            }
            
            updateAlertDisplay() {
                const container = document.getElementById('active-alerts');
                const countElement = document.getElementById('alert-count');
                
                if (!container) return;
                
                const activeAlerts = this.alerts.filter(a => a.active);
                countElement.textContent = activeAlerts.length;
                
                if (activeAlerts.length === 0) {
                    container.innerHTML = `
                        <div class="list-group-item text-center text-muted">
                            <i class="fas fa-bell-slash"></i><br>
                            <small>No active alerts</small>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                activeAlerts.slice(0, 5).forEach(alert => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    
                    let icon = 'fa-bell';
                    let color = 'warning';
                    if (alert.type.includes('whale')) {
                        icon = 'fa-whale';
                        color = 'primary';
                    } else if (alert.type.includes('scam')) {
                        icon = 'fa-skull-crossbones';
                        color = 'danger';
                    } else if (alert.type.includes('pump')) {
                        icon = 'fa-rocket';
                        color = 'success';
                    }
                    
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas ${icon} text-${color}"></i>
                                <strong class="ms-2">${alert.token}</strong>
                                <br>
                                <small>${alert.message || alert.type.replace('_', ' ')}</small>
                            </div>
                            <div>
                                <small class="text-muted me-2">${alert.createdAt}</small>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="alertSystem.removeAlert(${alert.id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
            
            scanForScams() {
                // Simulate scam scanning
                setInterval(() => {
                    if (!this.dashboard || !this.dashboard.coins) return;
                    
                    // Check for potential scam patterns
                    this.dashboard.coins.forEach(coin => {
                        if (coin.safetyScore < 30 && !this.scamTokens.has(coin.symbol)) {
                            this.scamTokens.add(coin.symbol);
                            this.triggerScamAlert(coin);
                        }
                        
                        // Check for extreme volatility
                        if (Math.abs(coin.priceChange1h) > 80) {
                            this.triggerVolatilityAlert(coin);
                        }
                    });
                }, 45000);
            }
            
            triggerScamAlert(coin) {
                const alert = {
                    id: Date.now(),
                    token: coin.symbol,
                    type: 'scam_detected',
                    message: `Potential scam detected! Safety score: ${coin.safetyScore}/100`,
                    priority: 'high',
                    active: true,
                    createdAt: new Date().toLocaleTimeString()
                };
                
                this.addAlert(alert);
                
                // Play scam sound
                if (localStorage.getItem('soundEnabled') !== 'false') {
                    const sound = document.getElementById('scam-sound');
                    if (sound) {
                        sound.currentTime = 0;
                        sound.play().catch(e => console.log('Audio play failed:', e));
                    }
                }
                
                // Update safety scanner display
                this.updateSafetyScanner([coin.symbol]);
            }
            
            triggerVolatilityAlert(coin) {
                const alert = {
                    id: Date.now(),
                    token: coin.symbol,
                    type: 'high_volatility',
                    message: `Extreme volatility: ${coin.priceChange1h > 0 ? '+' : ''}${coin.priceChange1h.toFixed(1)}% in 1h`,
                    priority: 'medium',
                    active: true,
                    createdAt: new Date().toLocaleTimeString()
                };
                
                this.addAlert(alert);
            }
            
            updateSafetyScanner(scamTokens) {
                const container = document.getElementById('safety-results');
                if (!container) return;
                
                if (scamTokens.length > 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>SCAM ALERT!</strong><br>
                                <small>Potential scams detected: ${scamTokens.join(', ')}</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-warning">
                                <i class="fas fa-shield-alt"></i>
                                <div>Low liquidity tokens found</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <i class="fas fa-check-circle"></i>
                                <div>${this.dashboard.coins.length - scamTokens.length} tokens safe</div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="col-md-4">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <div>No scams detected</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <i class="fas fa-shield-alt"></i>
                                <div>Liquidity checks passed</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-warning">
                                <i class="fas fa-clock"></i>
                                <div>Monitoring 24/7</div>
                            </div>
                        </div>
                    `;
                }
            }
            
            setupNotificationPermission() {
                if (Notification.permission === 'default') {
                    setTimeout(() => {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                console.log('Desktop notifications enabled');
                            }
                        });
                    }, 3000);
                }
            }
        }

        // ==================== MAIN DASHBOARD ====================
        class MemeCoinDashboard {
            constructor() {
                this.coins = [];
                this.filteredCoins = [];
                this.currentFilter = 'all';
                this.whaleTransactions = [];
                this.alerts = [];
                this.portfolioValue = 1000;
                this.selectedToken = null;
                this.apiService = new ApiService();
                this.whaleTracker = new WhaleTracker();
                this.alertSystem = new AlertSystem();
                this.isLoading = false;
                this.tradeHistory = [];
                
                this.init();
            }
            
            async init() {
                // Load settings
                document.getElementById('whale-threshold').value = 
                    localStorage.getItem('whaleThreshold') || CONFIG.WHALE_THRESHOLD_USD;
                document.getElementById('stop-loss').value = 
                    localStorage.getItem('stopLoss') || 15;
                document.getElementById('take-profit').value = 
                    localStorage.getItem('takeProfit') || 30;
                document.getElementById('auto-buy').checked = 
                    localStorage.getItem('autoBuyEnabled') === 'true';
                
                // Initialize settings
                initSettings();
                
                // Test APIs first
                await this.apiService.testAllAPIs();
                
                // Load initial data
                await this.fetchCoins();
                this.setupEventListeners();
                this.setupAutoRefresh();
                
                // Initialize systems
                this.whaleTracker.init(this);
                this.alertSystem.init(this);
                
                // Set initial sound button state
                const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
                const soundBtn = document.getElementById('toggle-alert-sound');
                soundBtn.innerHTML = `<i class="fas fa-volume-${soundEnabled ? 'up' : 'mute'}"></i> Sound ${soundEnabled ? 'ON' : 'OFF'}`;
                
                // Update last update time
                this.updateLastUpdateTime();
            }
            
            async fetchCoins() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                try {
                    document.getElementById('coin-data').innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                Fetching real-time meme coin data...
                            </td>
                        </tr>
                    `;
                    
                    // Get trending coins
                    const coins = await this.apiService.getTrendingCoins();
                    
                    if (coins && coins.length > 0) {
                        this.coins = coins;
                        this.applyFilter(this.currentFilter);
                        this.updateLastUpdateTime();
                        
                        // Update status
                        document.getElementById('update-status').className = 'badge bg-success';
                        document.getElementById('update-status').textContent = 'Updated';
                        
                        // Show success toast
                        this.showToast(`Loaded ${coins.length} meme coins`, 'success');
                    } else {
                        throw new Error('No coins received from API');
                    }
                    
                } catch (error) {
                    console.error('Error fetching coins:', error);
                    this.showToast('Using simulated data', 'warning');
                    
                    // Use simulated data as fallback
                    this.coins = this.apiService.getSimulatedTrendingData();
                    this.applyFilter(this.currentFilter);
                } finally {
                    this.isLoading = false;
                }
            }
            
            applyFilter(filter) {
                this.currentFilter = filter;
                this.filteredCoins = [...this.coins];
                
                switch(filter) {
                    case 'rising':
                        this.filteredCoins = this.filteredCoins
                            .filter(coin => coin.priceChange1h > 5)
                            .sort((a, b) => b.priceChange1h - a.priceChange1h);
                        break;
                    case 'whale':
                        this.filteredCoins = this.filteredCoins
                            .filter(coin => coin.whaleScore > 70)
                            .sort((a, b) => b.whaleScore - a.whaleScore);
                        break;
                    case 'new':
                        this.filteredCoins = this.filteredCoins
                            .filter(coin => coin.ageInHours < 24)
                            .sort((a, b) => a.ageInHours - b.ageInHours);
                        break;
                    case 'scam':
                        this.filteredCoins = this.filteredCoins
                            .filter(coin => coin.safetyScore < 40)
                            .sort((a, b) => a.safetyScore - b.safetyScore);
                        break;
                    default:
                        this.filteredCoins.sort((a, b) => b.volume24h - a.volume24h);
                }
                
                this.renderTable();
            }
            
            renderTable() {
                const tbody = document.getElementById('coin-data');
                
                if (!this.filteredCoins || this.filteredCoins.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center">
                                <div class="alert alert-info py-2">
                                    <i class="fas fa-info-circle"></i> 
                                    No coins match current filter.
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = '';
                
                this.filteredCoins.forEach((coin, index) => {
                    const price = coin.price ? 
                        `$${coin.price < 0.001 ? coin.price.toFixed(8) : 
                              coin.price < 0.01 ? coin.price.toFixed(6) : 
                              coin.price.toFixed(4)}` : 
                        'N/A';
                    
                    const change1h = coin.priceChange1h || 0;
                    const change24h = coin.priceChange24h || 0;
                    
                    const volume = coin.volume24h ? 
                        `$${(coin.volume24h / 1000).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}K` : 
                        'N/A';
                    
                    const liquidity = coin.liquidity ? 
                        `$${(coin.liquidity / 1000).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}K` : 
                        'N/A';
                    
                    const age = coin.ageInHours < 24 ? 
                        `${coin.ageInHours.toFixed(1)}h` : 
                        `${(coin.ageInHours / 24).toFixed(1)}d`;
                    
                    // Safety indicator
                    let safetyIcon = 'fa-check-circle text-success';
                    let safetyText = 'Safe';
                    if (coin.safetyScore < 30) {
                        safetyIcon = 'fa-skull-crossbones text-danger';
                        safetyText = 'SCAM';
                    } else if (coin.safetyScore < 50) {
                        safetyIcon = 'fa-exclamation-triangle text-warning';
                        safetyText = 'Risky';
                    } else if (coin.safetyScore < 70) {
                        safetyIcon = 'fa-shield-alt text-info';
                        safetyText = 'Medium';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="token-logo">
                                    ${coin.symbol.charAt(0)}
                                </div>
                                <div>
                                    <strong>${coin.symbol}</strong>
                                    <br>
                                    <small class="text-muted">${coin.name.substring(0, 15)}${coin.name.length > 15 ? '...' : ''}</small>
                                </div>
                            </div>
                        </td>
                        <td><strong>${price}</strong></td>
                        <td class="${change1h >= 0 ? 'positive' : 'negative'}">
                            ${change1h >= 0 ? '+' : ''}${change1h.toFixed(2)}%
                        </td>
                        <td class="${change24h >= 0 ? 'positive' : 'negative'}">
                            ${change24h >= 0 ? '+' : ''}${change24h.toFixed(2)}%
                        </td>
                        <td>${volume}</td>
                        <td>${liquidity}</td>
                        <td>${age}</td>
                        <td>
                            <i class="fas ${safetyIcon}" title="Safety score: ${coin.safetyScore || 'N/A'}"></i>
                            <small class="ms-1">${safetyText}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="dashboard.selectToken('${coin.symbol}')">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="dashboard.setAlert('${coin.symbol}')">
                                <i class="fas fa-bell"></i>
                            </button>
                        </td>
                    `;
                    
                    // Add scam warning background
                    if (coin.safetyScore < 30) {
                        row.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                    } else if (coin.safetyScore < 50) {
                        row.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
                    }
                    
                    row.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            this.selectToken(coin.symbol);
                        }
                    });
                    
                    tbody.appendChild(row);
                });
            }
            
            selectToken(symbol) {
                this.selectedToken = this.coins.find(c => c.symbol === symbol);
                
                if (this.selectedToken) {
                    // Show token details in modal
                    const modalContent = `
                        <div class="row">
                            <div class="col-md-6">
                                <h5>${this.selectedToken.symbol} - ${this.selectedToken.name}</h5>
                                <p><strong>Price:</strong> $${this.selectedToken.price?.toFixed(6) || 'N/A'}</p>
                                <p><strong>1h Change:</strong> <span class="${this.selectedToken.priceChange1h >= 0 ? 'positive' : 'negative'}">
                                    ${this.selectedToken.priceChange1h >= 0 ? '+' : ''}${this.selectedToken.priceChange1h?.toFixed(2) || '0'}%
                                </span></p>
                                <p><strong>24h Change:</strong> <span class="${this.selectedToken.priceChange24h >= 0 ? 'positive' : 'negative'}">
                                    ${this.selectedToken.priceChange24h >= 0 ? '+' : ''}${this.selectedToken.priceChange24h?.toFixed(2) || '0'}%
                                </span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>24h Volume:</strong> $${(this.selectedToken.volume24h || 0).toLocaleString()}</p>
                                <p><strong>Liquidity:</strong> $${(this.selectedToken.liquidity || 0).toLocaleString()}</p>
                                <p><strong>Age:</strong> ${this.selectedToken.ageInHours < 24 ? 
                                    this.selectedToken.ageInHours.toFixed(1) + ' hours' : 
                                    (this.selectedToken.ageInHours / 24).toFixed(1) + ' days'}</p>
                                <p><strong>Safety Score:</strong> ${this.selectedToken.safetyScore || 'N/A'}/100</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-danger" onclick="dashboard.scanTokenSafety(dashboard.selectedToken)">
                                <i class="fas fa-search"></i> Full Safety Scan
                            </button>
                            <button class="btn btn-success ms-2" onclick="dashboard.simulateTrade('buy', dashboard.selectedToken.symbol, 100)">
                                <i class="fas fa-shopping-cart"></i> Simulate Buy
                            </button>
                        </div>
                    `;
                    
                    this.showModal('Token Details', modalContent);
                }
            }
            
            setAlert(tokenSymbol) {
                const threshold = document.getElementById('whale-threshold').value;
                const coin = this.coins.find(c => c.symbol === tokenSymbol);
                
                if (!coin) {
                    this.showToast('Token not found', 'error');
                    return;
                }
                
                const alert = {
                    id: Date.now(),
                    token: tokenSymbol,
                    type: 'price_alert',
                    message: `Alert for ${tokenSymbol} when whale buy > $${threshold}`,
                    threshold: threshold,
                    active: true,
                    createdAt: new Date().toLocaleTimeString()
                };
                
                this.alerts.push(alert);
                this.alertSystem.addAlert(alert);
                
                // Also add to whale tracker watchlist
                if (coin.address && coin.address.startsWith('mock_')) {
                    this.whaleTracker.addPairToWatch(coin.address);
                }
                
                this.showToast(`Alert set for ${tokenSymbol}`, 'success');
            }
            
            updateLastUpdateTime() {
                const now = new Date();
                document.getElementById('last-update').textContent = 
                    `Updated: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                
                // Update status badge
                const statusElement = document.getElementById('live-status');
                statusElement.className = 'badge bg-success pulse';
                statusElement.innerHTML = '<i class="fas fa-circle"></i> Live';
            }
            
            setupEventListeners() {
                // Filter buttons
                document.querySelectorAll('[data-filter]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('[data-filter]').forEach(b => 
                            b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.applyFilter(e.target.dataset.filter);
                    });
                });
                
                // Save settings
                document.getElementById('save-settings').addEventListener('click', () => {
                    localStorage.setItem('whaleThreshold', document.getElementById('whale-threshold').value);
                    localStorage.setItem('stopLoss', document.getElementById('stop-loss').value);
                    localStorage.setItem('takeProfit', document.getElementById('take-profit').value);
                    localStorage.setItem('autoBuyEnabled', document.getElementById('auto-buy').checked.toString());
                    
                    // Update whale tracker threshold
                    this.whaleTracker.whaleThreshold = document.getElementById('whale-threshold').value;
                    
                    this.showToast('Settings saved!', 'success');
                });
                
                // Toggle alert sound
                document.getElementById('toggle-alert-sound').addEventListener('click', (e) => {
                    const enabled = localStorage.getItem('soundEnabled') !== 'false';
                    localStorage.setItem('soundEnabled', (!enabled).toString());
                    e.target.innerHTML = `<i class="fas fa-volume-${enabled ? 'mute' : 'up'}"></i> Sound ${enabled ? 'OFF' : 'ON'}`;
                    this.showToast(`Sound ${enabled ? 'disabled' : 'enabled'}`, 'info');
                });
                
                // Simulation buttons
                document.getElementById('sim-buy').addEventListener('click', () => {
                    const amount = parseFloat(document.getElementById('buy-amount').value);
                    if (this.selectedToken) {
                        this.simulateTrade('buy', this.selectedToken.symbol, amount);
                    } else {
                        this.showToast('Select a token first', 'warning');
                    }
                });
                
                document.getElementById('sim-sell').addEventListener('click', () => {
                    const amount = parseFloat(document.getElementById('sell-amount').value);
                    if (this.selectedToken) {
                        this.simulateTrade('sell', this.selectedToken.symbol, amount);
                    } else {
                        this.showToast('Select a token first', 'warning');
                    }
                });
                
                // Force refresh
                document.getElementById('force-refresh').addEventListener('click', () => {
                    this.fetchCoins();
                    this.showToast('Refreshing data...', 'info');
                });
                
                // Test APIs
                document.getElementById('test-apis').addEventListener('click', async () => {
                    this.showToast('Testing all APIs...', 'info');
                    await this.apiService.testAllAPIs();
                    this.showToast('API tests complete', 'success');
                });
                
                // Show trades
                document.getElementById('show-trades').addEventListener('click', () => {
                    this.showTradeHistory();
                });
            }
            
            simulateTrade(type, symbol, amount) {
                const coin = this.coins.find(c => c.symbol === symbol);
                if (!coin) return;
                
                const trade = {
                    id: Date.now(),
                    type: type,
                    symbol: symbol,
                    amount: amount,
                    price: coin.price,
                    value: amount * coin.price,
                    time: new Date().toLocaleTimeString(),
                    profit: type === 'sell' ? (amount * coin.price * 0.05) : 0 // Simulate 5% profit on sell
                };
                
                this.tradeHistory.unshift(trade);
                
                if (type === 'buy') {
                    this.portfolioValue -= amount;
                    this.showToast(`Simulated BUY: ${amount} USDC of ${symbol}`, 'success');
                } else {
                    this.portfolioValue += amount + trade.profit;
                    this.showToast(`Simulated SELL: ${amount} USDC of ${symbol} (Profit: $${trade.profit.toFixed(2)})`, 'success');
                }
                
                // Update portfolio display
                document.getElementById('portfolio-value').textContent = 
                    this.portfolioValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // Update whale feed with trade
                const transaction = {
                    id: Date.now(),
                    token: symbol,
                    type: type === 'buy' ? 'simulated_buy' : 'simulated_sell',
                    amount: `$${amount}`,
                    price: `$${coin.price.toFixed(6)}`,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    address: 'simulated_trade'
                };
                
                this.whaleTransactions.unshift(transaction);
                this.updateWhaleFeed();
            }
            
            showTradeHistory() {
                if (this.tradeHistory.length === 0) {
                    this.showModal('Trade History', '<p>No trades yet. Start simulating trades!</p>');
                    return;
                }
                
                let historyHtml = '<div class="table-responsive"><table class="table table-dark table-sm"><thead><tr><th>Time</th><th>Type</th><th>Token</th><th>Amount</th><th>Price</th><th>Value</th></tr></thead><tbody>';
                
                this.tradeHistory.slice(0, 10).forEach(trade => {
                    historyHtml += `
                        <tr>
                            <td>${trade.time}</td>
                            <td><span class="badge ${trade.type === 'buy' ? 'bg-success' : 'bg-danger'}">${trade.type.toUpperCase()}</span></td>
                            <td>${trade.symbol}</td>
                            <td>$${trade.amount}</td>
                            <td>$${trade.price?.toFixed(6) || 'N/A'}</td>
                            <td>$${(trade.value || 0).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                historyHtml += '</tbody></table></div>';
                historyHtml += `<p class="text-muted">Total trades: ${this.tradeHistory.length}</p>`;
                
                this.showModal('Trade History', historyHtml);
            }
            
            scanTokenSafety(token) {
                if (!token) return;
                
                const safetyScore = token.safetyScore || 50;
                let safetyMessage = '';
                let safetyColor = 'success';
                
                if (safetyScore < 30) {
                    safetyMessage = 'âŒ HIGH RISK - POTENTIAL SCAM\nâ€¢ Low liquidity\nâ€¢ New token\nâ€¢ Extreme volatility';
                    safetyColor = 'danger';
                } else if (safetyScore < 50) {
                    safetyMessage = 'âš ï¸ MODERATE RISK\nâ€¢ Moderate liquidity\nâ€¢ Somewhat volatile\nâ€¢ Trade carefully';
                    safetyColor = 'warning';
                } else if (safetyScore < 70) {
                    safetyMessage = 'âš ï¸ MEDIUM RISK\nâ€¢ Decent liquidity\nâ€¢ Normal volatility\nâ€¢ Average safety';
                    safetyColor = 'info';
                } else {
                    safetyMessage = 'âœ… RELATIVELY SAFE\nâ€¢ Good liquidity\nâ€¢ Stable price\nâ€¢ Established token';
                    safetyColor = 'success';
                }
                
                const modalContent = `
                    <div class="alert alert-${safetyColor}">
                        <h5>Safety Scan Results for ${token.symbol}</h5>
                        <p><strong>Overall Safety Score:</strong> ${safetyScore}/100</p>
                        <pre class="text-white">${safetyMessage}</pre>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Liquidity:</strong> $${(token.liquidity || 0).toLocaleString()}</p>
                            <p><strong>24h Volume:</strong> $${(token.volume24h || 0).toLocaleString()}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Token Age:</strong> ${token.ageInHours < 24 ? 
                                token.ageInHours.toFixed(1) + ' hours' : 
                                (token.ageInHours / 24).toFixed(1) + ' days'}</p>
                            <p><strong>Whale Score:</strong> ${token.whaleScore || 'N/A'}/100</p>
                        </div>
                    </div>
                `;
                
                this.showModal('Safety Scan Results', modalContent);
            }
            
            setupAutoRefresh() {
                // Auto-refresh data every minute
                setInterval(() => {
                    if (!this.isLoading) {
                        this.fetchCoins();
                    }
                }, CONFIG.UPDATE_INTERVAL);
                
                // Update time display every minute
                setInterval(() => {
                    const now = new Date();
                    const updateElement = document.getElementById('update-status');
                    if (updateElement) {
                        updateElement.textContent = 
                            `Updated: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    }
                }, 60000);
            }
            
            updateWhaleFeed() {
                const feed = document.getElementById('whale-feed');
                if (!feed) return;
                
                const allTransactions = [...this.whaleTransactions, ...(this.whaleTracker.transactionHistory || [])];
                
                if (allTransactions.length === 0) {
                    feed.innerHTML = `
                        <div class="list-group-item text-center">
                            <i class="fas fa-whale text-muted"></i><br>
                            <small class="text-muted">Waiting for whale activity...</small>
                        </div>
                    `;
                    return;
                }
                
                // Sort by time (newest first) and limit
                const sortedTransactions = allTransactions
                    .sort((a, b) => b.id - a.id)
                    .slice(0, CONFIG.MAX_WHALE_TRANSACTIONS);
                
                feed.innerHTML = '';
                
                sortedTransactions.forEach(tx => {
                    const item = document.createElement('div');
                    item.className = `list-group-item alert-item ${tx.type.includes('buy') ? 'whale-buy' : 'whale-sell'}`;
                    
                    let icon = 'fa-arrow-up text-success';
                    let typeText = 'BUY';
                    if (tx.type.includes('sell')) {
                        icon = 'fa-arrow-down text-danger';
                        typeText = 'SELL';
                    } else if (tx.type.includes('simulated')) {
                        icon = 'fa-user text-info';
                        typeText = tx.type.replace('simulated_', '').toUpperCase();
                    }
                    
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <div>
                                <i class="fas ${icon}"></i>
                                <strong class="ms-2">${tx.token}</strong>
                                <span class="badge ${tx.type.includes('buy') ? 'bg-success' : 'bg-danger'} ms-2">
                                    ${typeText}
                                </span>
                                ${tx.whaleSize ? `<span class="badge bg-dark ms-1">${tx.whaleSize}</span>` : ''}
                            </div>
                            <small class="text-muted">${tx.time}</small>
                        </div>
                        <div class="mt-1">
                            <span class="badge bg-dark">Amount: ${tx.amount}</span>
                            <span class="badge bg-secondary ms-1">Price: ${tx.price}</span>
                        </div>
                    `;
                    feed.appendChild(item);
                });
            }
            
            showModal(title, content) {
                const modalId = 'customModal';
                let modal = document.getElementById(modalId);
                
                if (!modal) {
                    modal = document.createElement('div');
                    modal.className = 'modal fade';
                    modal.id = modalId;
                    modal.tabIndex = -1;
                    modal.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">${title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body" id="${modalId}Body">
                                    ${content}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    document.getElementById(`${modalId}Body`).innerHTML = content;
                    const modalTitle = modal.querySelector('.modal-title');
                    if (modalTitle) modalTitle.textContent = title;
                }
                
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
            }
            
            showToast(message, type = 'info') {
                const toastId = 'toast-' + Date.now();
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0`;
                toast.id = toastId;
                toast.setAttribute('role', 'alert');
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.right = '20px';
                toast.style.zIndex = '9999';
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                            type === 'error' ? 'exclamation-circle' : 
                                            type === 'warning' ? 'exclamation-triangle' : 
                                            'info-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                const bsToast = new bootstrap.Toast(toast, {
                    autohide: true,
                    delay: 3000
                });
                bsToast.show();
                
                toast.addEventListener('hidden.bs.toast', () => {
                    toast.remove();
                });
            }
        }

        // ==================== INITIALIZATION ====================
        let dashboard;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                dashboard = new MemeCoinDashboard();
                window.dashboard = dashboard;
                window.alertSystem = dashboard.alertSystem;
                window.whaleTracker = dashboard.whaleTracker;
                
                // Show welcome message
                setTimeout(() => {
                    dashboard.showToast('Meme Coin Whale Tracker Started!', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                document.getElementById('coin-data').innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                Initialization error: ${error.message}
                                <br>
                                <button class="btn btn-sm btn-warning mt-2" onclick="location.reload()">
                                    <i class="fas fa-redo"></i> Reload Page
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        });
    </script>
</body>
</html>

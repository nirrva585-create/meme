<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana Meme Whale Viewer + Auto Scam/Rug/Safe Zones (No Keys)</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #58a6ff; text-align: center; }
    #controls { text-align: center; margin: 20px 0; }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin: 0 10px;
    }
    button:hover { background: #2ea043; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: #161b22;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #30363d;
    }
    th { background: #21262d; }
    .whale { background: #1f2a1a !important; }
    .high-risk { background: rgba(248, 81, 73, 0.18) !important; }
    .watch-risk { background: rgba(242, 201, 76, 0.12) !important; }

    .change-up    { color: #56d364; font-weight: bold; }
    .change-down  { color: #f85149; font-weight: bold; }
    .change-neutral { color: #8b949e; }

    .zone-buy  { color: #56d364; font-weight: bold; background: rgba(86, 211, 100, 0.1); }
    .zone-sell { color: #f2c94c; font-weight: bold; background: rgba(242, 201, 76, 0.1); }

    .risk-safe   { color: #56d364; font-weight: bold; }
    .risk-watch  { color: #f2c94c; font-weight: bold; }
    .risk-danger { color: #f85149; font-weight: bold; }

    .lp-locked   { color: #56d364; }
    .lp-partial  { color: #f2c94c; }
    .lp-unlocked { color: #f85149; font-weight: bold; }

    a { color: #58a6ff; text-decoration: none; }
    a:hover { text-decoration: underline; }

    #log {
      background: #0d1117;
      border: 1px solid #30363d;
      padding: 15px;
      height: 280px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.95rem;
      border-radius: 6px;
      margin-top: 20px;
    }
    .alert-buy   { color: #56d364; font-weight: bold; }
    .alert-sell  { color: #f2c94c; font-weight: bold; }
    .alert-whale { color: #f2c94c; font-weight: bold; }
    .alert-scam  { color: #ff6b6b; font-weight: bold; background: rgba(255,107,107,0.12); }
    .alert-retry { color: #f2994a; }
  </style>
</head>
<body>

<h1>Solana Meme Coins â€” Whale + Auto Scam/Rug/Safe Zones</h1>

<div id="controls">
  <button onclick="fetchAndShow()">Refresh Now</button>
  <p>Auto-refreshes every 15â€“20s â€¢ All free public APIs â€¢ No keys needed</p>
</div>

<table>
  <thead>
    <tr>
      <th>Token</th>
      <th>Symbol</th>
      <th>Price</th>
      <th>5m Î”</th>
      <th>24h Î”</th>
      <th>Market Cap</th>
      <th>Liquidity</th>
      <th>Vol 24h</th>
      <th>Holders</th>
      <th>Sentiment (5m)</th>
      <th>LP Safety</th>
      <th>Risk Alert</th>
      <th>Zone Alert</th>
      <th>Age</th>
      <th>Whale (5m)</th>
      <th>DexScreener</th>
    </tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>

<div id="log">
  <strong>Alerts, Safe Zones & Warnings</strong><br>
</div>

<!-- Sounds -->
<audio id="whale-sound" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
<audio id="buy-sound"  src="https://www.soundjay.com/buttons/beep-08b.mp3"></audio>
<audio id="sell-sound" src="https://www.soundjay.com/buttons/beep-10.mp3"></audio>
<audio id="scam-sound" src="https://www.soundjay.com/buttons/beep-09.mp3"></audio>
<audio id="zone-sound" src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG â€“ no keys needed
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PUMP_API       = "https://frontend-api.pump.fun/coins?offset=0&limit=15&sort=created_timestamp&order=desc";
const BIRDEYE_TRADE  = "https://public-api.birdeye.so/defi/txs/token";
const BIRDEYE_TOKEN  = "https://public-api.birdeye.so/defi/token_overview?address=";
const DEXSCREENER    = "https://api.dexscreener.com/latest/dex/search?q=";
const SOL_MINT       = "So11111111111111111111111111111111111111112";

const WHALE_USD      = 500;
const VOLUME_BUY_THR = 30000;
const VOLUME_SELL_THR = 25000;
const SAFE_BUY_DIP   = -15;
const SAFE_SELL_PUMP = 50;
const LOW_LIQ_THR    = 10000;
const LOW_HOLDERS_THR = 150;
const REFRESH_MS     = 18000; // 18s â€“ safer for rate limits

const MAX_RETRIES    = 3;
const RETRY_DELAY_MS = 2000;

const whaleSound = document.getElementById("whale-sound");
const buySound   = document.getElementById("buy-sound");
const sellSound  = document.getElementById("sell-sound");
const scamSound  = document.getElementById("scam-sound");
const zoneSound  = document.getElementById("zone-sound");

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DOM + Log
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const logDiv = document.getElementById("log");
const tbody  = document.getElementById("table-body");

function addLog(msg, type = "info") {
  const div = document.createElement("div");
  div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
  div.className = `alert-${type}`;
  logDiv.appendChild(div);
  logDiv.scrollTop = logDiv.scrollHeight;

  if (type.includes("buy") || type.includes("zone-buy")) zoneSound.play().catch(() => {});
  if (type.includes("sell") || type.includes("zone-sell")) sellSound.play().catch(() => {});
  if (type === "whale") whaleSound.play().catch(() => {});
  if (type === "scam")  scamSound.play().catch(() => {});
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Retry wrapper
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function withRetry(fn, name = "fetch") {
  let attempt = 0;
  while (attempt < MAX_RETRIES) {
    try {
      return await fn();
    } catch (err) {
      attempt++;
      const delay = RETRY_DELAY_MS * Math.pow(2, attempt - 1);
      if (attempt === MAX_RETRIES) {
        addLog(`${name} failed after ${MAX_RETRIES} tries: ${err.message}`, "alert-retry");
        return null; // silent fail â€“ return null instead of crashing
      }
      await new Promise(r => setTimeout(r, delay));
    }
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Data fetchers (all free & public)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getDexScreenerData(mint) {
  return withRetry(async () => {
    const res = await fetch(DEXSCREENER + encodeURIComponent(`${mint} SOL`));
    if (!res.ok) throw new Error(`DexScreener ${res.status}`);
    const data = await res.json();
    if (data.pairs?.length > 0) {
      const p = data.pairs[0];
      return {
        url: p.url || `https://dexscreener.com/solana/${mint}`,
        liquidity: p.liquidity?.usd || 0,
        volume24h: p.volume?.h24 || 0,
        priceChange24h: p.priceChange?.h24 || 0,
        priceChange5mApprox: p.priceChange?.m5 || 0,
        lpLockedPct: p.liquidity?.lockedPct || 0 // some pairs expose this
      };
    }
    return { url: `https://dexscreener.com/solana/${mint}`, liquidity: 0, volume24h: 0, priceChange24h: 0, priceChange5mApprox: 0, lpLockedPct: 0 };
  }, `DexScreener ${mint.slice(0,6)}`);
}

async function getRecentTradeStats(mint) {
  return withRetry(async () => {
    const now = Math.floor(Date.now() / 1000);
    const from = now - 300;
    const url = `${BIRDEYE_TRADE}?address=${mint}&tx_type=swap&sort_type=desc&from_time=${from}&to_time=${now}&limit=50&ui_amount_mode=raw`;
    const res = await fetch(url, { headers: { 'x-chain': 'solana' } });
    if (!res.ok) throw new Error(`Birdeye trades ${res.status}`);
    const data = await res.json();
    const trades = data.data?.items || [];

    let buyVol = 0, sellVol = 0, buyCount = 0, sellCount = 0, smallBuyCount = 0;
    for (const t of trades) {
      const usd = t.valueUsdc || t.valueUsd || 0;
      if (t.tokenIn?.address === SOL_MINT && t.tokenOut?.address === mint) {
        buyVol += usd; buyCount++; if (usd < 10) smallBuyCount++;
      } else if (t.tokenOut?.address === SOL_MINT && t.tokenIn?.address === mint) {
        sellVol += usd; sellCount++;
      }
    }
    return { buyVol, sellVol, buyCount, sellCount, smallBuyCount };
  }, `Birdeye trades ${mint.slice(0,6)}`);
}

async function getHoldersCount(mint) {
  return withRetry(async () => {
    const res = await fetch(`${BIRDEYE_TOKEN}${mint}`, { headers: { 'x-chain': 'solana' } });
    if (!res.ok) throw new Error(`Birdeye holders ${res.status}`);
    const data = await res.json();
    return data.data?.holder || 0;
  }, `Birdeye holders ${mint.slice(0,6)}`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Risk & Zone Logic (no RugCheck key needed)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calculateRiskLevel(liquidity, holders, priceChange5m, volume24h, smallBuyCount, lpLockedPct) {
  let score = 0;

  if (liquidity < LOW_LIQ_THR) score += 4;
  if (holders < LOW_HOLDERS_THR) score += 3;
  if (priceChange5m > FAKE_PUMP_THR && volume24h < 50000) score += 3;
  if (smallBuyCount > 12) score += 2;
  if (lpLockedPct < 50 && lpLockedPct > 0) score += 3; // partial lock penalty

  if (score >= 8) return { level: "high", text: `ğŸ”´ High Risk (low liq/LP/holders)`, class: "risk-danger" };
  if (score >= 4) return { level: "watch", text: `ğŸŸ¡ Watch (early / partial LP)`, class: "risk-watch" };
  return { level: "safe", text: `ğŸŸ¢ Safe`, class: "risk-safe" };
}

function formatLpLock(pct) {
  if (pct <= 0 || !pct) return "â€” (no data)";
  if (pct >= 90) return `<span class="lp-locked">Locked (${pct.toFixed(0)}%)</span>`;
  if (pct >= 50) return `<span class="lp-partial">Partial (${pct.toFixed(0)}%)</span>`;
  return `<span class="lp-unlocked">Low/Unlocked (${pct.toFixed(0)}%)</span>`;
}

function detectSafeZones(priceChange5m, priceChange24h, liquidity, buyVol, sellVol, lpLockedPct) {
  let zone = "-";
  let alertType = null;
  let msg = "";

  // Safe Buy Zone
  if ((priceChange5m < SAFE_BUY_DIP || priceChange24h < SAFE_BUY_DIP * 1.5) &&
      liquidity > LOW_LIQ_THR * 1.5 &&
      buyVol > sellVol * 1.2 &&
      lpLockedPct >= 50) {
    zone = "ğŸŸ¢ Safe Buy Zone";
    alertType = "zone-buy";
    msg = `SAFE BUY ZONE â†’ ${coin.name} dipped but liq & LP support rebound`;
  }

  // Safe Sell Zone
  if (priceChange5m > SAFE_SELL_PUMP || priceChange24h > SAFE_SELL_PUMP * 2) {
    zone = "ğŸŸ¡ Safe Sell Zone";
    alertType = "zone-sell";
    msg = `TAKE PROFIT ZONE â†’ ${coin.name} pumped hard â€” consider exit`;
  }

  if (msg) addLog(msg, alertType);

  return { zone, alertType };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Formatters (unchanged)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatChange(pct) {
  if (!pct && pct !== 0) return "â€”";
  const sign = pct > 0 ? "+" : "";
  const cls = pct > 10 ? "change-up" : pct < -10 ? "change-down" : "change-neutral";
  return `<span class="${cls}">${sign}${pct.toFixed(2)}% ${pct > 0 ? 'â†‘' : pct < 0 ? 'â†“' : ''}</span>`;
}

function formatBig(n) {
  if (!n || n <= 0) return "â€”";
  if (n >= 1e6) return `$${(n/1e6).toFixed(2)}M`;
  if (n >= 1e3) return `$${(n/1e3).toFixed(1)}K`;
  return `$${n.toFixed(0)}`;
}

function formatHolders(n) {
  if (!n || n <= 0) return "â€”";
  return n.toLocaleString();
}

function getSentimentClass(buyVol, sellVol) {
  if (buyVol > sellVol * 1.5) return "sentiment-buy";
  if (sellVol > buyVol * 1.5) return "sentiment-sell";
  return "sentiment-neut";
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Main loop
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchAndShow() {
  let failedCount = 0;

  try {
    const coins = await withRetry(async () => {
      const res = await fetch(PUMP_API);
      if (!res.ok) throw new Error(`Pump API ${res.status}`);
      return await res.json();
    }, "Pump.fun list", 2);

    tbody.innerHTML = "";

    for (const coin of coins) {
      try {
        const [dexData, tradeStats, holders] = await Promise.all([
          getDexScreenerData(coin.mint),
          getRecentTradeStats(coin.mint),
          getHoldersCount(coin.mint)
        ]);

        const whaleCount = tradeStats.buyVol >= WHALE_USD ? 1 : 0;
        const isWhale    = whaleCount > 0;

        // Alerts
        if (tradeStats.buyVol > VOLUME_BUY_THR && tradeStats.buyVol > tradeStats.sellVol * 1.3) {
          addLog(`BUY PRESSURE â†’ ${coin.name} (${coin.symbol})`, "buy");
        }
        if (tradeStats.sellVol > VOLUME_SELL_THR && tradeStats.sellVol > tradeStats.buyVol * 1.3) {
          addLog(`SELL PRESSURE â†’ ${coin.name} (${coin.symbol})`, "sell");
        }
        if (isWhale) {
          addLog(`WHALE BUY â†’ ${coin.name} (${coin.symbol})`, "whale");
        }

        // Safe zones
        const zoneInfo = detectSafeZones(
          dexData.priceChange5mApprox,
          dexData.priceChange24h,
          dexData.liquidity,
          tradeStats.buyVol,
          tradeStats.sellVol,
          dexData.lpLockedPct
        );

        // Risk
        const risk = calculateRiskLevel(
          dexData.liquidity,
          holders,
          dexData.priceChange5mApprox,
          dexData.volume24h,
          tradeStats.smallBuyCount,
          dexData.lpLockedPct
        );

        if (risk.level === "high") {
          addLog(`HIGH RISK â†’ ${coin.name}: low liq/LP/holders`, "scam");
        }

        const row = document.createElement("tr");
        if (isWhale) row.className = "whale";
        if (risk.level === "high") row.classList.add("high-risk");
        if (risk.level === "watch") row.classList.add("watch-risk");

        row.innerHTML = `
          <td>${coin.name}</td>
          <td>${coin.symbol}</td>
          <td>$${price.toFixed(6)}</td>
          <td>${formatChange(dexData.priceChange5mApprox || 0)}</td>
          <td>${formatChange(dexData.priceChange24h)}</td>
          <td>${formatBig(marketCap)}</td>
          <td>${formatBig(dexData.liquidity)}</td>
          <td>${formatBig(dexData.volume24h)}</td>
          <td>${formatHolders(holders)}</td>
          <td class="${getSentimentClass(tradeStats.buyVol, tradeStats.sellVol)}">${tradeStats.buyCount || 0}â†‘ / ${tradeStats.sellCount || 0}â†“</td>
          <td class="${dexData.lpLockedPct >= 90 ? 'lp-locked' : dexData.lpLockedPct >= 50 ? 'lp-partial' : 'lp-unlocked'}">
            ${formatLpLock(dexData.lpLockedPct)}
          </td>
          <td class="${risk.class}">${risk.text}</td>
          <td class="${zoneInfo.alertType || ''}">${zoneInfo.zone}</td>
          <td>${age}</td>
          <td>${whaleCount > 0 ? `ğŸ³ ${whaleCount}` : '-'}</td>
          <td><a href="${dexData.url}" target="_blank" rel="noopener noreferrer">View</a></td>
        `;
        tbody.appendChild(row);
      } catch (coinErr) {
        failedCount++;
      }
    }

    addLog(`Table refreshed (${failedCount > 0 ? failedCount + ' skipped' : 'OK'})`);
  } catch (err) {
    addLog(`Global load failed: ${err.message} â€” retrying next cycle`, "alert-retry");
    tbody.innerHTML = "<tr><td colspan='16'>Data load failed â€” retrying next cycle...</td></tr>";
  }
}

// Auto-refresh
setInterval(fetchAndShow, REFRESH_MS);

// Start
fetchAndShow();
addLog("Started â€” all free APIs, no keys needed", "info");
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana Meme Whale Viewer + RugCheck + Retry Logic</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      margin: 0;
      padding: 20px;
    }
    h1 { color: #58a6ff; text-align: center; }
    #controls { text-align: center; margin: 20px 0; }
    button {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin: 0 10px;
    }
    button:hover { background: #2ea043; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: #161b22;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #30363d;
    }
    th { background: #21262d; }
    .whale { background: #1f2a1a !important; }
    .high-risk { background: rgba(248, 81, 73, 0.18) !important; }
    .watch-risk { background: rgba(242, 201, 76, 0.12) !important; }

    .change-up    { color: #56d364; font-weight: bold; }
    .change-down  { color: #f85149; font-weight: bold; }
    .change-neutral { color: #8b949e; }

    .risk-safe   { color: #56d364; font-weight: bold; }
    .risk-watch  { color: #f2c94c; font-weight: bold; }
    .risk-danger { color: #f85149; font-weight: bold; }

    .lp-locked   { color: #56d364; }
    .lp-partial  { color: #f2c94c; }
    .lp-unlocked { color: #f85149; font-weight: bold; }

    a { color: #58a6ff; text-decoration: none; }
    a:hover { text-decoration: underline; }

    #log {
      background: #0d1117;
      border: 1px solid #30363d;
      padding: 15px;
      height: 280px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.95rem;
      border-radius: 6px;
      margin-top: 20px;
    }
    .alert-buy   { color: #56d364; font-weight: bold; }
    .alert-sell  { color: #f2c94c; font-weight: bold; }
    .alert-whale { color: #f2c94c; font-weight: bold; }
    .alert-scam  { color: #ff6b6b; font-weight: bold; background: rgba(255,107,107,0.12); }
    .alert-retry { color: #f2994a; }
  </style>
</head>
<body>

<h1>Solana Meme Coins — Whale + RugCheck + Safe Zones</h1>

<div id="controls">
  <button onclick="fetchAndShow()">Refresh Now</button>
  <p>Auto-refreshes every 12s • Whale ≥ $500 • With retry logic for stability</p>
</div>

<table>
  <thead>
    <tr>
      <th>Token</th>
      <th>Symbol</th>
      <th>Price</th>
      <th>5m Δ</th>
      <th>24h Δ</th>
      <th>Market Cap</th>
      <th>Liquidity</th>
      <th>Vol 24h</th>
      <th>Holders</th>
      <th>Sentiment (5m)</th>
      <th>LP Locked</th>
      <th>RugCheck Risk</th>
      <th>Zone Alert</th>
      <th>Age</th>
      <th>Whale (5m)</th>
      <th>DexScreener</th>
    </tr>
  </thead>
  <tbody id="table-body"></tbody>
</table>

<div id="log">
  <strong>Alerts, Zones & Retry Log</strong><br>
</div>

<!-- Sounds -->
<audio id="whale-sound" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
<audio id="buy-sound"  src="https://www.soundjay.com/buttons/beep-08b.mp3"></audio>
<audio id="sell-sound" src="https://www.soundjay.com/buttons/beep-10.mp3"></audio>
<audio id="scam-sound" src="https://www.soundjay.com/buttons/beep-09.mp3"></audio>
<audio id="zone-sound" src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>

<script>
// ────────────────────────────────────────────────
// CONFIG
// ────────────────────────────────────────────────
const RUGCHECK_API_KEY = ""; // ← PASTE YOUR RUGCHECK API KEY HERE

const PUMP_API       = "https://frontend-api.pump.fun/coins?offset=0&limit=20&sort=created_timestamp&order=desc";
const BIRDEYE_TRADE  = "https://public-api.birdeye.so/defi/txs/token";
const BIRDEYE_TOKEN  = "https://public-api.birdeye.so/defi/token_overview?address=";
const DEXSCREENER    = "https://api.dexscreener.com/latest/dex/search?q=";
const RUGCHECK_BASE  = "https://api.rugcheck.xyz/v1/tokens/";
const SOL_MINT       = "So11111111111111111111111111111111111111112";

const WHALE_USD      = 500;
const VOLUME_BUY_THR = 30000;
const VOLUME_SELL_THR = 25000;
const SAFE_BUY_DIP   = -15;
const SAFE_SELL_PUMP = 50;
const LOW_LIQ_THR    = 10000;
const LOW_HOLDERS_THR = 150;
const REFRESH_MS     = 15000; // slightly longer to reduce rate-limit pressure

const MAX_RETRIES    = 3;
const RETRY_DELAY_MS = 2000; // base delay, increases exponentially

const whaleSound = document.getElementById("whale-sound");
const buySound   = document.getElementById("buy-sound");
const sellSound  = document.getElementById("sell-sound");
const scamSound  = document.getElementById("scam-sound");
const zoneSound  = document.getElementById("zone-sound");

// ────────────────────────────────────────────────
// DOM + Log
// ────────────────────────────────────────────────
const logDiv = document.getElementById("log");
const tbody  = document.getElementById("table-body");

function addLog(msg, type = "info") {
  const div = document.createElement("div");
  div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
  div.className = `alert-${type}`;
  logDiv.appendChild(div);
  logDiv.scrollTop = logDiv.scrollHeight;

  if (type.includes("buy") || type.includes("zone-buy")) zoneSound.play().catch(() => {});
  if (type.includes("sell") || type.includes("zone-sell")) sellSound.play().catch(() => {});
  if (type === "whale") whaleSound.play().catch(() => {});
  if (type === "scam")  scamSound.play().catch(() => {});
}

// ────────────────────────────────────────────────
// Retry wrapper
// ────────────────────────────────────────────────
async function withRetry(fn, name = "fetch", maxRetries = MAX_RETRIES) {
  let attempt = 0;
  while (attempt < maxRetries) {
    try {
      return await fn();
    } catch (err) {
      attempt++;
      const delay = RETRY_DELAY_MS * Math.pow(2, attempt - 1);
      if (attempt === maxRetries) {
        addLog(`${name} failed after ${maxRetries} retries: ${err.message}`, "alert-retry");
        throw err; // let caller handle final failure
      }
      await new Promise(r => setTimeout(r, delay));
    }
  }
}

// ────────────────────────────────────────────────
// Fetch functions with retry
// ────────────────────────────────────────────────
async function getDexScreenerData(mint) {
  return withRetry(async () => {
    const res = await fetch(DEXSCREENER + encodeURIComponent(`${mint} SOL`));
    if (!res.ok) throw new Error(`DexScreener ${res.status}`);
    const data = await res.json();
    if (data.pairs?.length > 0) {
      const p = data.pairs[0];
      return {
        url: p.url || `https://dexscreener.com/solana/${mint}`,
        liquidity: p.liquidity?.usd || 0,
        volume24h: p.volume?.h24 || 0,
        priceChange24h: p.priceChange?.h24 || 0,
        priceChange5mApprox: p.priceChange?.m5 || 0
      };
    }
    return { url: `https://dexscreener.com/solana/${mint}`, liquidity: 0, volume24h: 0, priceChange24h: 0, priceChange5mApprox: 0 };
  }, `DexScreener for ${mint.slice(0,6)}`);
}

async function getRecentTradeStats(mint) {
  return withRetry(async () => {
    const now = Math.floor(Date.now() / 1000);
    const from = now - 300;
    const url = `${BIRDEYE_TRADE}?address=${mint}&tx_type=swap&sort_type=desc&from_time=${from}&to_time=${now}&limit=60&ui_amount_mode=raw`;
    const res = await fetch(url, { headers: { 'x-chain': 'solana' } });
    if (!res.ok) throw new Error(`Birdeye trades ${res.status}`);
    const data = await res.json();
    const trades = data.data?.items || [];

    let buyVol = 0, sellVol = 0, buyCount = 0, sellCount = 0, smallBuyCount = 0;
    for (const t of trades) {
      const usd = t.valueUsdc || t.valueUsd || 0;
      if (t.tokenIn?.address === SOL_MINT && t.tokenOut?.address === mint) {
        buyVol += usd; buyCount++; if (usd < 10) smallBuyCount++;
      } else if (t.tokenOut?.address === SOL_MINT && t.tokenIn?.address === mint) {
        sellVol += usd; sellCount++;
      }
    }
    return { buyVol, sellVol, buyCount, sellCount, smallBuyCount };
  }, `Birdeye trades ${mint.slice(0,6)}`);
}

async function getHoldersCount(mint) {
  return withRetry(async () => {
    const res = await fetch(`${BIRDEYE_TOKEN}${mint}`, { headers: { 'x-chain': 'solana' } });
    if (!res.ok) throw new Error(`Birdeye holders ${res.status}`);
    const data = await res.json();
    return data.data?.holder || 0;
  }, `Birdeye holders ${mint.slice(0,6)}`);
}

async function getRugCheckData(mint) {
  if (!RUGCHECK_API_KEY) return { score: null, risk: "no_key", lpLocked: null, lpLockedPct: 0, message: "No key" };

  return withRetry(async () => {
    const url = `${RUGCHECK_BASE}${mint}/report/summary`;
    const res = await fetch(url, {
      headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${RUGCHECK_API_KEY}` }
    });
    if (!res.ok) throw new Error(`RugCheck ${res.status}`);
    const data = await res.json();

    return {
      score: data.rug_score ?? data.risk_score ?? null,
      risk: data.risk_level?.toLowerCase() ?? "unknown",
      lpLocked: data.lp_locked ?? data.lp_burned ?? false,
      lpLockedPct: data.lp_locked_percentage ?? data.lp_lock_pct ?? 0,
      message: data.warning_count > 0 ? `${data.warning_count} warnings` : "clean"
    };
  }, `RugCheck ${mint.slice(0,6)}`);
}

// ────────────────────────────────────────────────
// (keep formatChange, formatBig, formatHolders, formatLpLock, getSentimentClass, calculateRiskLevel, detectSafeZones as before)

// ────────────────────────────────────────────────
// Main loop with better error handling
// ────────────────────────────────────────────────
async function fetchAndShow() {
  let failedCount = 0;

  try {
    const coins = await withRetry(async () => {
      const res = await fetch(PUMP_API);
      if (!res.ok) throw new Error(`Pump API ${res.status}`);
      return await res.json();
    }, "Pump.fun list", 2);

    tbody.innerHTML = "";

    for (const coin of coins) {
      try {
        const [dexData, tradeStats, holders, rugCheck] = await Promise.all([
          getDexScreenerData(coin.mint),
          getRecentTradeStats(coin.mint),
          getHoldersCount(coin.mint),
          getRugCheckData(coin.mint)
        ]);

        // ... rest of per-coin logic (whale detection, alerts, safe zones, risk calc, row creation) remains the same

        // Example (shortened):
        const whaleCount = tradeStats.buyVol >= WHALE_USD ? 1 : 0;
        const zoneInfo = detectSafeZones(/* params */);
        const risk = calculateRiskLevel(/* params */);

        const row = document.createElement("tr");
        // ... fill row as before ...
        tbody.appendChild(row);
      } catch (coinErr) {
        failedCount++;
        // Silent per-coin failure - no crash, just skip
      }
    }

    addLog(`Table refreshed (${failedCount > 0 ? failedCount + ' coins skipped' : 'OK'})`);
  } catch (globalErr) {
    addLog(`Global fetch failed: ${globalErr.message} — will retry next cycle`, "alert-retry");
    tbody.innerHTML = "<tr><td colspan='16'>Data load failed — retrying next cycle...</td></tr>";
  }
}

// Auto-refresh
setInterval(fetchAndShow, REFRESH_MS);

// Initial load
fetchAndShow();
addLog("Started — with retry logic enabled", "info");
</script>

</body>
</html>

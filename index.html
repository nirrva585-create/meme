<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana Meme Whale + Jupiter + TP/SL</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #0d1117; color: #c9d1d9; margin: 0; padding: 20px; }
    h1, h3 { color: #58a6ff; }
    #wallet { text-align: center; margin: 10px 0; font-weight: bold; }
    button { background: #238636; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; margin: 4px; }
    button:disabled { background: #444; cursor: not-allowed; }
    input { padding: 6px 10px; margin: 4px; width: 80px; background: #1e252e; color: white; border: 1px solid #444; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; background: #161b22; border-radius: 8px; overflow: hidden; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #30363d; }
    th { background: #21262d; }
    .whale { background: #1f2a1a !important; }
    .high-risk { background: rgba(248, 81, 73, 0.18) !important; }
    .watch-risk { background: rgba(242, 201, 76, 0.12) !important; }
    .pnl-positive { color: #56d364; }
    .pnl-negative { color: #f85149; }
    .zone-buy  { color: #56d364; font-weight: bold; background: rgba(86, 211, 100, 0.1); }
    .zone-sell { color: #f2c94c; font-weight: bold; background: rgba(242, 201, 76, 0.1); }
    #log { background: #0d1117; border: 1px solid #30363d; padding: 15px; height: 240px; overflow-y: auto; font-family: monospace; margin-top: 20px; border-radius: 6px; }
    .alert-buy   { color: #56d364; font-weight: bold; }
    .alert-sell  { color: #f2c94c; font-weight: bold; }
    .alert-whale { color: #f2c94c; font-weight: bold; }
    .alert-scam  { color: #ff6b6b; font-weight: bold; background: rgba(255,107,107,0.12); }
    .alert-retry { color: #f2994a; }
  </style>
</head>
<body>

<h1>Solana Meme Whale Viewer + Jupiter DEX + TP/SL</h1>

<div id="wallet">Wallet: not connected</div>
<button id="connect-wallet">Connect Phantom</button>
<button id="refresh">Refresh Now</button>

<h3>Hot Meme Coins</h3>
<table>
  <thead>
    <tr>
      <th>Token</th>
      <th>Symbol</th>
      <th>Price</th>
      <th>5m Δ</th>
      <th>24h Δ</th>
      <th>Market Cap</th>
      <th>Liquidity</th>
      <th>Vol 24h</th>
      <th>Holders</th>
      <th>LP Safety</th>
      <th>Risk Alert</th>
      <th>Zone Alert</th>
      <th>Whale (5m)</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="coins-table"></tbody>
</table>

<h3>Open Positions (with TP/SL)</h3>
<table>
  <thead>
    <tr>
      <th>Token</th>
      <th>Amount</th>
      <th>Entry Price</th>
      <th>Current Price</th>
      <th>PnL %</th>
      <th>TP Level</th>
      <th>SL Level</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="positions-table"></tbody>
</table>

<div id="log"><strong>Log & Alerts</strong><br></div>

<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@solana/spl-token@0.4.8/lib/index.iife.min.js"></script>

<script>
// ────────────────────────────────────────────────
// CONFIG
// ────────────────────────────────────────────────
const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");
let wallet = null;
let positions = JSON.parse(localStorage.getItem("meme_positions") || "[]");

const PUMP_API = "https://frontend-api.pump.fun/coins?offset=0&limit=12&sort=created_timestamp&order=desc";
const DEXSCREENER = "https://api.dexscreener.com/latest/dex/search?q=";
const BIRDEYE_TOKEN = "https://public-api.birdeye.so/defi/token_overview?address=";
const BIRDEYE_TRADE = "https://public-api.birdeye.so/defi/txs/token";
const JUPITER_QUOTE = "https://quote-api.jup.ag/v6/quote";
const JUPITER_SWAP  = "https://quote-api.jup.ag/v6/swap";
const SOL_MINT = "So11111111111111111111111111111111111111112";

const LAMPORTS_PER_SOL = 1_000_000_000;
const SLIPPAGE_BPS = 500;
const DEFAULT_TP_PCT = 80;
const DEFAULT_SL_PCT = -25;
const REFRESH_MS = 18000;
const MAX_RETRIES = 3;
const RETRY_DELAY_MS = 2000;

const whaleSound = new Audio("https://www.soundjay.com/buttons/beep-07.mp3");
const buySound   = new Audio("https://www.soundjay.com/buttons/beep-08b.mp3");
const sellSound  = new Audio("https://www.soundjay.com/buttons/beep-10.mp3");
const scamSound  = new Audio("https://www.soundjay.com/buttons/beep-09.mp3");
const zoneSound  = new Audio("https://www.soundjay.com/buttons/beep-01a.mp3");

// ────────────────────────────────────────────────
// Log
// ────────────────────────────────────────────────
const logDiv = document.getElementById("log");
function addLog(msg, type = "info") {
  const div = document.createElement("div");
  div.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
  div.className = `alert-${type}`;
  logDiv.appendChild(div);
  logDiv.scrollTop = logDiv.scrollHeight;

  if (type.includes("buy") || type.includes("zone-buy")) zoneSound.play().catch(() => {});
  if (type.includes("sell") || type.includes("zone-sell")) sellSound.play().catch(() => {});
  if (type === "whale") whaleSound.play().catch(() => {});
  if (type === "scam") scamSound.play().catch(() => {});
}

// ────────────────────────────────────────────────
// Wallet Connection
// ────────────────────────────────────────────────
document.getElementById("connect-wallet").onclick = async () => {
  if ("solana" in window) {
    wallet = window.solana;
    try {
      await wallet.connect();
      document.getElementById("wallet").textContent = `Wallet: ${wallet.publicKey.toString().slice(0,8)}...`;
      addLog("Phantom connected");
      renderPositions();
    } catch (err) {
      addLog("Connection failed: " + err.message);
    }
  } else {
    addLog("Phantom not detected. Install it.");
  }
};

// ────────────────────────────────────────────────
// Retry Wrapper
// ────────────────────────────────────────────────
async function withRetry(fn, name = "fetch") {
  let attempt = 0;
  while (attempt < MAX_RETRIES) {
    try {
      return await fn();
    } catch (err) {
      attempt++;
      const delay = RETRY_DELAY_MS * Math.pow(2, attempt - 1);
      if (attempt === MAX_RETRIES) {
        addLog(`${name} failed after ${MAX_RETRIES} tries: ${err.message}`, "alert-retry");
        return null;
      }
      await new Promise(r => setTimeout(r, delay));
    }
  }
}

// ────────────────────────────────────────────────
// Data Fetchers
// ────────────────────────────────────────────────
async function getDexScreenerData(mint) {
  return withRetry(async () => {
    const res = await fetch(DEXSCREENER + encodeURIComponent(`${mint} SOL`));
    if (!res.ok) throw new Error(`DexScreener ${res.status}`);
    const data = await res.json();
    if (data.pairs?.length > 0) {
      const p = data.pairs[0];
      return {
        url: p.url || `https://dexscreener.com/solana/${mint}`,
        liquidity: p.liquidity?.usd || 0,
        volume24h: p.volume?.h24 || 0,
        priceChange24h: p.priceChange?.h24 || 0,
        priceChange5mApprox: p.priceChange?.m5 || 0,
        lpLockedPct: p.liquidity?.lockedPct || 0
      };
    }
    return { url: `https://dexscreener.com/solana/${mint}`, liquidity: 0, volume24h: 0, priceChange24h: 0, priceChange5mApprox: 0, lpLockedPct: 0 };
  }, `DexScreener ${mint.slice(0,6)}`);
}

async function getRecentTradeStats(mint) {
  return withRetry(async () => {
    const now = Math.floor(Date.now() / 1000);
    const from = now - 300;
    const url = `${BIRDEYE_TRADE}?address=${mint}&tx_type=swap&sort_type=desc&from_time=${from}&to_time=${now}&limit=50&ui_amount_mode=raw`;
    const res = await fetch(url, { headers: { 'x-chain': 'solana' } });
    if (!res.ok) throw new Error(`Birdeye trades ${res.status}`);
    const data = await res.json();
    const trades = data.data?.items || [];

    let buyVol = 0, sellVol = 0, buyCount = 0, sellCount = 0, smallBuyCount = 0;
    for (const t of trades) {
      const usd = t.valueUsdc || t.valueUsd || 0;
      if (t.tokenIn?.address === SOL_MINT && t.tokenOut?.address === mint) {
        buyVol += usd; buyCount++; if (usd < 10) smallBuyCount++;
      } else if (t.tokenOut?.address === SOL_MINT && t.tokenIn?.address === mint) {
        sellVol += usd; sellCount++;
      }
    }
    return { buyVol, sellVol, buyCount, sellCount, smallBuyCount };
  }, `Birdeye trades ${mint.slice(0,6)}`);
}

async function getHoldersCount(mint) {
  return withRetry(async () => {
    const res = await fetch(`${BIRDEYE_TOKEN}${mint}`, { headers: { 'x-chain': 'solana' } });
    if (!res.ok) throw new Error(`Birdeye holders ${res.status}`);
    const data = await res.json();
    return data.data?.holder || 0;
  }, `Birdeye holders ${mint.slice(0,6)}`);
}

// ────────────────────────────────────────────────
// Jupiter DEX
// ────────────────────────────────────────────────
async function getJupiterQuote(inputMint, outputMint, amount) {
  const url = `${JUPITER_QUOTE}?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=${SLIPPAGE_BPS}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error("Jupiter quote failed");
  return res.json();
}

async function getJupiterSwapTx(quote, userPubkey) {
  const res = await fetch(JUPITER_SWAP, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      quoteResponse: quote,
      userPublicKey: userPubkey,
      wrapAndUnwrapSol: true,
      computeUnitPriceMicroLamports: 150000
    })
  });
  if (!res.ok) throw new Error("Jupiter swap tx failed");
  const { swapTransaction } = await res.json();
  return VersionedTransaction.deserialize(Buffer.from(swapTransaction, "base64"));
}

async function executeTx(tx) {
  const signedTx = await wallet.signTransaction(tx);
  const rawTx = signedTx.serialize();
  const sig = await connection.sendRawTransaction(rawTx, { skipPreflight: true, maxRetries: 3 });
  await connection.confirmTransaction(sig, "confirmed");
  return sig;
}

// ────────────────────────────────────────────────
// Buy / Sell with TP/SL
// ────────────────────────────────────────────────
async function buyToken(mint, solAmount = 0.05) {
  if (!wallet?.publicKey) return addLog("Wallet not connected");

  try {
    addLog(`Buying ~${solAmount} SOL of ${mint.slice(0,6)}...`);
    const lamports = Math.floor(solAmount * LAMPORTS_PER_SOL);
    const quote = await getJupiterQuote(SOL_MINT, mint, lamports);

    const tx = await getJupiterSwapTx(quote, wallet.publicKey.toString());
    const sig = await executeTx(tx);

    addLog(`Buy success! Sig: ${sig.slice(0,8)}...`);

    const solPrice = 150; // fallback
    const entryPrice = (solAmount * solPrice) / (Number(quote.outAmount) / 1e6);
    const tpPrice = entryPrice * (1 + DEFAULT_TP_PCT / 100);
    const slPrice = entryPrice * (1 + DEFAULT_SL_PCT / 100);

    positions.push({
      mint,
      name: coin?.name || "Token",
      amount: Number(quote.outAmount) / 1e6,
      entryPriceUsd: entryPrice,
      tpPriceUsd: tpPrice,
      slPriceUsd: slPrice,
      timestamp: Date.now()
    });

    localStorage.setItem("meme_positions", JSON.stringify(positions));
    renderPositions();
  } catch (err) {
    addLog("Buy failed: " + err.message);
  }
}

async function sellToken(position) {
  if (!wallet?.publicKey) return addLog("Wallet not connected");

  try {
    addLog(`Selling ${position.mint.slice(0,6)}...`);
    const amount = Math.floor(position.amount * 1e6);
    const quote = await getJupiterQuote(position.mint, SOL_MINT, amount);

    const tx = await getJupiterSwapTx(quote, wallet.publicKey.toString());
    const sig = await executeTx(tx);

    addLog(`Sell success! Sig: ${sig.slice(0,8)}...`);

    positions = positions.filter(p => p.mint !== position.mint);
    localStorage.setItem("meme_positions", JSON.stringify(positions));
    renderPositions();
  } catch (err) {
    addLog("Sell failed: " + err.message);
  }
}

// ────────────────────────────────────────────────
// TP/SL Check
// ────────────────────────────────────────────────
async function checkTpSl() {
  if (!positions.length) return;

  for (const pos of [...positions]) {
    try {
      const res = await fetch(DEXSCREENER + encodeURIComponent(`${pos.mint} SOL`));
      const data = await res.json();
      const currentPrice = data.pairs?.[0]?.priceUsd || 0;

      if (currentPrice >= pos.tpPriceUsd) {
        addLog(`TAKE PROFIT HIT → ${pos.mint.slice(0,6)} @ $${currentPrice.toFixed(6)}`);
        await sellToken(pos);
      } else if (currentPrice <= pos.slPriceUsd) {
        addLog(`STOP LOSS HIT → ${pos.mint.slice(0,6)} @ $${currentPrice.toFixed(6)}`);
        await sellToken(pos);
      }
    } catch {}
  }
}

// ────────────────────────────────────────────────
// Render positions
// ────────────────────────────────────────────────
function renderPositions() {
  const tbody = document.getElementById("positions-table");
  tbody.innerHTML = "";

  positions.forEach(pos => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${pos.mint.slice(0,6)}...</td>
      <td>${pos.amount.toFixed(2)}</td>
      <td>$${pos.entryPriceUsd.toFixed(6)}</td>
      <td id="cur-${pos.mint}">Loading...</td>
      <td id="pnl-${pos.mint}">0%</td>
      <td>TP: $${pos.tpPriceUsd.toFixed(6)} (+${DEFAULT_TP_PCT}%)</td>
      <td>SL: $${pos.slPriceUsd.toFixed(6)} (${DEFAULT_SL_PCT}%)</td>
      <td><button onclick="sellToken(${JSON.stringify(pos)})">Sell</button></td>
    `;
    tbody.appendChild(tr);

    fetch(DEXSCREENER + encodeURIComponent(`${pos.mint} SOL`))
      .then(r => r.json())
      .then(d => {
        const price = d.pairs?.[0]?.priceUsd || 0;
        document.getElementById(`cur-${pos.mint}`).textContent = `$${price.toFixed(6)}`;
        const pnl = ((price - pos.entryPriceUsd) / pos.entryPriceUsd * 100).toFixed(2);
        const cls = pnl > 0 ? "pnl-positive" : pnl < 0 ? "pnl-negative" : "";
        document.getElementById(`pnl-${pos.mint}`).innerHTML = `<span class="${cls}">${pnl}%</span>`;
      });
  });
}

// ────────────────────────────────────────────────
// Main fetch (simplified whale/risk logic)
// ────────────────────────────────────────────────
async function fetchAndShow() {
  try {
    const res = await fetch(PUMP_API);
    const coins = await res.json();

    const tbody = document.getElementById("coins-table");
    tbody.innerHTML = "";

    for (const coin of coins) {
      const price = coin.price || 0;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${coin.name}</td>
        <td>${coin.symbol}</td>
        <td>$${price.toFixed(6)}</td>
        <td>N/A</td>
        <td>N/A</td>
        <td>N/A</td>
        <td><button onclick="buyToken('${coin.mint}')">Buy 0.05 SOL</button></td>
      `;
      tbody.appendChild(row);
    }

    await checkTpSl();
    renderPositions();
    addLog("Table & positions updated");
  } catch (err) {
    addLog("Data load failed: " + err.message);
  }
}

// ────────────────────────────────────────────────
// Start
// ────────────────────────────────────────────────
document.getElementById("refresh").onclick = fetchAndShow;
setInterval(fetchAndShow, REFRESH_MS);
fetchAndShow();
renderPositions();
addLog("Started — Jupiter DEX + TP/SL active");
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Safe Solana Meme Scanner – Whale Tx + Rug/Bot/Holders</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #0f0f1a;
      color: #e0e0ff;
      margin: 0;
      padding: 20px;
    }
    h1 { text-align: center; color: #a78bfa; }
    #controls { text-align: center; margin-bottom: 20px; }
    button { 
      background-color: #7c3aed; 
      color: white; 
      padding: 10px 20px; 
      border: none; 
      cursor: pointer; 
      border-radius: 6px;
      font-weight: bold;
    }
    button:hover { background-color: #9f7aea; }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 20px; 
      background: #161b22;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td { 
      border: 1px solid #2d2d44; 
      padding: 10px; 
      text-align: left; 
    }
    th { 
      background-color: #2d2d44; 
      color: white; 
    }
    .safe   { background-color: rgba(86, 211, 100, 0.12); }
    .watch  { background-color: rgba(242, 201, 76, 0.12); }
    .danger { background-color: rgba(248, 81, 73, 0.18); font-weight: bold; }
    .holders-low   { color: #f85149; }
    .holders-mid   { color: #f2c94c; }
    .holders-high  { color: #56d364; }
    .whale-buy  { color: #7ee787; font-weight: bold; }
    .whale-sell { color: #ff6b6b; font-weight: bold; }
    #log { 
      background-color: #1e1e2e; 
      border: 1px solid #444; 
      padding: 15px; 
      height: 260px; 
      overflow-y: scroll; 
      margin-top: 20px; 
      font-family: monospace;
      border-radius: 6px;
    }
    .alert { color: #ff6b6b; font-weight: bold; }
  </style>
</head>
<body>

<h1>Fast Safe Meme Scanner – Whale Transactions + Rug/Bot/Holders</h1>

<div id="controls">
  <button onclick="fetchAndShow()">Refresh Now</button>
  <p>Refreshes every ~10–12 seconds • Only safe coins • Whale Tx / Bot / Rug alerts with sound</p>
</div>

<table>
  <thead>
    <tr>
      <th>Token</th>
      <th>Price</th>
      <th>Market Cap</th>
      <th>Liquidity</th>
      <th>5m Vol</th>
      <th>5m Change</th>
      <th>Holders</th>
      <th>Whale Tx (5m)</th>
      <th>Rug Risk</th>
    </tr>
  </thead>
  <tbody id="coins-table"></tbody>
</table>

<div id="log"><strong>Alerts & Log (Whale Tx / Bot / Rug)</strong><br></div>

<audio id="whale-buy" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>
<audio id="whale-sell" src="https://www.soundjay.com/buttons/beep-10.mp3"></audio>
<audio id="bot-alert" src="https://www.soundjay.com/buttons/beep-08b.mp3"></audio>
<audio id="rug-alert" src="https://www.soundjay.com/buttons/beep-09.mp3"></audio>

<script>
// ────────────────────────────────────────────────
// CONFIG
// ────────────────────────────────────────────────
const DEXSCREENER_API = "https://api.dexscreener.com/latest/dex/pairs/solana?rankBy=volume&order=desc&limit=8";
const BIRDEYE_OVERVIEW = "https://public-api.birdeye.so/defi/token_overview?address=";
const BIRDEYE_TRADE = "https://public-api.birdeye.so/defi/txs/token";
const SOL_MINT = "So11111111111111111111111111111111111111112";

const REFRESH_MS = 10000; // 10 seconds
const MAX_RETRIES = 3;
const RETRY_DELAY_MS = 1500;

const WHALE_SINGLE_TX_USD = 50000; // single trade > $50k = whale tx
const LOW_LIQ_USD = 10000;
const LOW_HOLDERS = 150;
const FAKE_PUMP_CHANGE = 250;
const LOW_VOL_5M = 8000;

let lastGoodData = [];

const whaleBuySound = document.getElementById("whale-buy");
const whaleSellSound = document.getElementById("whale-sell");
const botAlertSound = document.getElementById("bot-alert");
const rugAlertSound = document.getElementById("rug-alert");

const logDiv = document.getElementById("log");
const tbody = document.getElementById("coins-table");

// ────────────────────────────────────────────────
// Log
// ────────────────────────────────────────────────
function addLog(msg, type = "info") {
  const p = document.createElement("p");
  p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  if (type === "whale-buy") p.style.color = "#7ee787";
  if (type === "whale-sell") p.style.color = "#ff6b6b";
  if (type === "bot") p.style.color = "#f2c94c";
  if (type === "rug") p.style.color = "#ff6b6b";
  if (type === "retry") p.style.color = "#f2994a";
  logDiv.appendChild(p);
  logDiv.scrollTop = logDiv.scrollHeight;

  if (type === "whale-buy") whaleBuySound.play().catch(() => {});
  if (type === "whale-sell") whaleSellSound.play().catch(() => {});
  if (type === "bot") botAlertSound.play().catch(() => {});
  if (type === "rug") rugAlertSound.play().catch(() => {});
}

// ────────────────────────────────────────────────
// Format
// ────────────────────────────────────────────────
function formatNumber(n) {
  if (!n || n <= 0) return "—";
  if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toFixed(0);
}

function formatHolders(n) {
  if (!n || n <= 0) return "—";
  if (n >= 10000) return (n / 1000).toFixed(1) + 'K+';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return n.toLocaleString();
}

// ────────────────────────────────────────────────
// Whale Tx + Rug + Bot Detection
// ────────────────────────────────────────────────
async function detectWhaleAndRisk(mint, pair) {
  const liq = pair.liquidity?.usd || 0;
  const vol5m = pair.volume?.m5 || 0;
  const change5m = pair.priceChange?.m5 || 0;

  let holders = 0;
  let whaleTx = "None";
  let whaleType = null;
  let risk = "safe";
  let reason = "";

  // Holders
  try {
    const res = await fetch(`${BIRDEYE_OVERVIEW}${mint}`, { headers: { 'x-chain': 'solana' } });
    if (res.ok) {
      const data = await res.json();
      holders = data.data?.holder || 0;
    }
  } catch {}

  // Whale transaction detection (large single trade)
  try {
    const now = Math.floor(Date.now() / 1000);
    const from = now - 300;
    const url = `${BIRDEYE_TRADE}?address=${mint}&tx_type=swap&sort_type=desc&from_time=${from}&to_time=${now}&limit=50&ui_amount_mode=raw`;
    const res = await fetch(url, { headers: { 'x-chain': 'solana' } });
    if (res.ok) {
      const data = await res.json();
      const trades = data.data?.items || [];

      for (const t of trades) {
        const usd = t.valueUsdc || t.valueUsd || 0;
        if (usd > WHALE_SINGLE_TX_USD) {
          if (t.tokenIn?.address === SOL_MINT && t.tokenOut?.address === mint) {
            whaleTx = `Big Buy $${formatNumber(usd)}`;
            whaleType = "buy";
            addLog(`WHALE BUY TX DETECTED: ${pair.baseToken.name} – $${formatNumber(usd)} single buy`, "whale-buy");
          } else if (t.tokenOut?.address === SOL_MINT && t.tokenIn?.address === mint) {
            whaleTx = `Big Sell $${formatNumber(usd)}`;
            whaleType = "sell";
            addLog(`WHALE SELL/DUMP TX DETECTED: ${pair.baseToken.name} – $${formatNumber(usd)} single sell`, "whale-sell");
          }
          break; // only flag the largest one
        }
      }
    }
  } catch {}

  // Rug risk
  if (liq < LOW_LIQ_USD) {
    risk = "danger";
    reason = "Low liquidity – high rug risk";
  }
  if (holders > 0 && holders < LOW_HOLDERS) {
    risk = holders < 100 ? "danger" : "watch";
    reason = reason ? reason + " + few holders" : "Very few holders – rug risk";
  }
  if (Math.abs(change5m) > FAKE_PUMP_CHANGE && vol5m < LOW_VOL_5M) {
    risk = "danger";
    reason = reason ? reason + " + fake pump" : "Extreme 5m pump + low vol – likely rug";
  }

  const holderClass = holders < 200 ? "holders-low" : holders < 1000 ? "holders-mid" : "holders-high";
  const whaleClass = whaleType === "buy" ? "whale-buy" : whaleType === "sell" ? "whale-sell" : "";

  return { holders, holderClass, whaleTx, whaleClass, risk, reason };
}

// ────────────────────────────────────────────────
// Fetch & render
// ────────────────────────────────────────────────
async function fetchAndShow() {
  try {
    const res = await fetch(DEXSCREENER_API);
    if (!res.ok) throw new Error(`DexScreener ${res.status}`);
    const data = await res.json();
    const pairs = data.pairs || [];

    tbody.innerHTML = "";

    for (const pair of pairs) {
      const mint = pair.baseToken.address;
      const { holders, holderClass, whaleTx, whaleClass, risk, reason } = await detectWhaleAndRisk(mint, pair);

      // Filter high rug risk
      if (risk === "danger") continue;

      const row = document.createElement("tr");
      row.className = risk === "safe" ? "safe" : "watch";
      row.innerHTML = `
        <td>${pair.baseToken.name} (${pair.baseToken.symbol})</td>
        <td>$${pair.priceUsd?.toFixed(6) || '—'}</td>
        <td>$${formatNumber(pair.fdv)}</td>
        <td>$${formatNumber(pair.liquidity?.usd)}</td>
        <td>$${formatNumber(pair.volume?.m5)}</td>
        <td>${pair.priceChange?.m5?.toFixed(2) || '—'}%</td>
        <td class="${holderClass}">${formatHolders(holders)}</td>
        <td class="${whaleClass}">${whaleTx || "—"}</td>
        <td>${reason || (risk === "safe" ? "Safe" : "Watch")}</td>
      `;
      tbody.appendChild(row);
    }

    lastGoodData = pairs;
    addLog("Refreshed successfully", "success");
  } catch (err) {
    addLog(`Load failed: ${err.message} – showing cached data`, "retry");

    tbody.innerHTML = "";
    lastGoodData.forEach(pair => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${pair.baseToken.name} (${pair.baseToken.symbol}) [cached]</td>
        <td>$${pair.priceUsd?.toFixed(6) || '—'}</td>
        <td>$${formatNumber(pair.fdv)}</td>
        <td>$${formatNumber(pair.liquidity?.usd)}</td>
        <td>$${formatNumber(pair.volume?.m5)}</td>
        <td>${pair.priceChange?.m5?.toFixed(2) || '—'}%</td>
        <td>Cached</td>
        <td>Cached</td>
        <td>Cached (refresh later)</td>
      `;
      tbody.appendChild(row);
    });
  }
}

// Start
fetchAndShow();
setInterval(fetchAndShow, REFRESH_MS);
addLog("Started – fast refresh with whale tx, holders & rug detection", "success");
</script>

</body>
</html>
